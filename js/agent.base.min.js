var agent=agent||{},user=user||{};
agent.productLovMutil=function(){var o={dv:null,categUl:null},callback=null,source="oe",iniAttrDefin=function(){if(ur.config().attributeDefin)for(k in ur.config().attributeDefin.product){var t=o.tbl.find("thead ."+k).show(),pa=ur.config().attributeDefin.product[k];t.show();t.find("a").text(pa.label)}},ini=function(){if(!o.dv){o.dv=$("#dvProductMutil");o.categUl=o.dv.find(".sidebar ul");o.categUl.find("li a").live("click",function(){getProduct(this)});o.tbl=o.dv.find(".report-results table");o.tbl.find("tbody tr input:checkbox").live("change",
function(){checkedProduct(this)});o.tbl.find("thead tr :checkbox").click(function(){checkedAll(this)});o.dv.find(".modal-footer .btn-success").click(function(){selected()});o.dv.find(".close").click(function(){callback([])});iniAttrDefin()}},selected=function(){var a=[];o.tbl.find("tbody tr :checked").each(function(){var b=[];b.push($(this).val());var tds=$(this).parents("tr").find("td");b.push(tds.eq(1).text());b.push(tds.eq(2).text());b.push(tds.eq(3).text());b.push($(this).attr("data-barcode"));
b.push("");b.push("");b.push(tds.eq(5).text());a.push(b)});o.dv.modal("hide");if(callback)callback(a)},checkedAll=function(obj){var cc=o.tbl.find("tbody:visible tr :checkbox"),checked=o.tbl.find("tbody:visible :checkbox:checked"),all=o.tbl.find("tbody:visible :checkbox"),c=o.dv.find(".page-header c");if($(obj).attr("checked")){cc.attr("checked","checked");c.html(all.size()-checked.size()+parseInt(c.html()))}else{cc.removeAttr("checked");c.html(parseInt(c.html())-checked.size())}},checkedProduct=function(obj){var c=
o.dv.find(".page-header c");if($(obj).attr("checked"))c.html(parseInt(c.html())+1);else c.html(parseInt(c.html())-1)};fdataCategory=function(a){var li=[],format='<li><a href="#" data-id="{0}">{1}</a></li>';for(var i=0,l=a.length;i<l;i++)li.push('<li><a href="#" data-id="'+a[i][0]+'">'+a[i][1]+"</a></li>");o.categUl.html(li.join("")).find("li:eq(0) a").click()},fdataProduct=function(a,tbody){var tr=[],b=[],format='<tr><td><input type="checkbox" value="{0}" data-barcode="{8}"/></td><td>{1}</td><td>{2}</td><td><small>{4}</small></td><td></td><td class="number">{7}</td></tr>';
for(var i=0,l=a.length;i<l;i++){b=[];b.push(dom.td('<input type="checkbox" value="'+a[i][0]+'" data-barcode="'+a[i][8]+'"/>'));b.push(dom.td(a[i][1]));b.push(dom.td(a[i][2],'class="number"'));b.push(dom.td("/<small>"+a[i][4]+"</small>"));b.push(dom.td(a[i][7]));if(o.tbl.find("thead th:eq(5)").css("display")!="none")b.push(dom.td(a[i][9]));else b.push(dom.td("","display:none"));if(o.tbl.find("thead th:eq(6)").css("display")!="none")b.push(dom.td(a[i][10]));else b.push(dom.td("","display:none"));tr.push(dom.tr(b.join("")))}tbody.html(tr.join(""));
o.dv.find(".page-header").find("d").text(gf.dateFormat(new Date,"yyyy-MM-dd HH:mm:ss"))};getCategory=function(){if(source=="oe")pgf.codeData("category",[ur.user().erpID],function(a){fdataCategory(a)});else gf.noPagination("up_member_getProductCategory",[o.agentId],function(a){fdataCategory(a)},1)},getProduct=function(cat){o.categUl.find(".active").removeClass("active");o.tbl.find("thead tr :checkbox").removeAttr("checked");var id=$(cat).parent().addClass("active").end().attr("data-id");o.tbl.find("tbody").hide();
var tbody=o.tbl.find("tbody[data-id="+id+"]");if(tbody.size()>0)tbody.show();else{tbody=$('<tbody data-id="'+id+'"></>').prependTo(o.tbl);if(source=="oe")pgf.codeData("product",[id],function(a){fdataProduct(a,tbody)});else gf.noPagination("up_member_getProduct",[id],function(a){fdataProduct(a,tbody)})}};o.show=function(callbk,src,agentId){ini();callback=callbk;source=src||"oe";o.agentId=agentId||ur.user().agentId;o.dv.modal({backdrop:"static"});getCategory();o.tbl.find(":checkbox:checked").removeAttr("checked");
o.dv.find(".page-header c").html(0)};return o}();
agent.productLov=function(){var o=$.extend({},gobj,{dvId:"dvProductLov"}),callback,ini=function(){if(!o.dv){o.preIni();o.tbl.find("tbody tr").live("click",function(){selectedProduct($(this))})}},selectedProduct=function(tr){tds=tr.find("td");var p={};p.id=tr.attr("data-id");p.code=tr.attr("data-barcode");p.name=tds.eq(0).text();p.price=tds.eq(1).text();p.uom=tds.eq(2).text();o.dv.modal("hide");callback?callback(p):null},getProduct=function(code){gf.noPagination("up_member_getProductByName",[ur.user().agentId,
code],function(a){var li=[],format='<tr data-id="{0}" data-barcode="{8}"><td>{1}</td><td>{2}</td><td><small>{4}</small></td><td>{7}</td></tr>';for(var i=0,len=a.length;i<len;i++)li.push(String.format.apply(null,[format].concat(a[i])));if(a.length==1)selectedProduct($(li[0]));else o.tbl.find("tbody").html(li)})};o.show=function(callbk,filter,type){ini();callback=callbk;o.dv.modal({backdrop:false});getProduct(filter||"")};return o}();
agent.memberLov=function(){var o=$.extend({},gobj,{dvId:"dvMemberLov"}),callback,ini=function(){if(!o.dv){o.preIni();o.tbl.find("tbody tr").live("click",function(){selectedPartner($(this))})}},selectedPartner=function(tr){tds=tr.find("td");var p={};p.id=tr.attr("data-id");p.code=tds.eq(1).text();p.name=tds.eq(2).text();p.discount=tr.attr("data-discount");o.dv.modal("hide");callback?callback(p):null},getPartner=function(type,code){gf.noPagination("up_member_stroeMemeber2",[ur.user().agentId,code||
""],function(a){var li=[],format='<tr data-id="{0}" data-discount="{6}"><td></td><td>{1}</td><td>{2}</td><td>{5}</td><td>{3}</td><td></td></tr>';for(var i=0,len=a.length;i<len;i++)li.push(String.format.apply(null,[format].concat(a[i])));if(a.length==1)selectedPartner($(li[0]));else o.tbl.find("tbody").html(li)})};o.show=function(callbk,filter,type){ini();callback=callbk;o.dv.modal({backdrop:false});getPartner(type||"",filter||"")};return o}();
agent.partnerLov=function(){var o=$.extend({},gobj,{dvId:"dvPartnerLov",proc:"up_member_stroeCustomer1",procCus:"up_member_stroeCustomer1",procVendor:"up_member_stroeVendorLov"}),callback,ini=function(){if(!o.dv){o.preIni();o.tbl.find("tbody tr").live("click",function(){selectedPartner($(this))})}},selectedPartner=function(tr){tds=tr.find("td");var p={};p.id=tr.attr("data-id");p.code=tds.eq(1).text();p.name=tds.eq(2).text();p.discount=tr.attr("data-discount");o.dv.modal("hide");callback?callback(p):
null},getPartner=function(type,code){gf.noPagination(o.proc,[ur.user().agentId,code||""],function(a){var li=[],format='<tr data-id="{0}" data-discount="{6}"><td></td><td>{1}</td><td>{2}</td><td>{5}</td><td>{3}</td><td></td></tr>';for(var i=0,len=a.length;i<len;i++)li.push(String.format.apply(null,[format].concat(a[i])));if(a.length==1)selectedPartner($(li[0]));else o.tbl.find("tbody").html(li)})};o.show=function(callbk,filter,type){ini();callback=callbk;o.dv.modal({backdrop:false});o.proc=o.procCus;
if(type=="vendor")o.proc=o.procVendor;getPartner(filter||"")};return o}();
agent.partnerMemberLov=function(){var o=$.extend({},gobj,{dvId:"dvPartnerLov"}),callback,ini=function(){if(!o.dv){o.preIni();o.tbl.find("tbody tr").live("click",function(){selectedPartner($(this))})}},selectedPartner=function(tr){tds=tr.find("td");var p={};p.id=tr.attr("data-id");p.code=tds.eq(1).text();p.name=tds.eq(2).text();p.discount=tr.attr("data-discount");o.dv.modal("hide");callback?callback(p):null},getPartner=function(type,code){gf.noPagination("up_member_stroeCustomerMember",[ur.user().agentId,
code||""],function(a){var li=[],format='<tr data-id="{0}" data-discount="{6}"><td></td><td>{1}</td><td>{2}</td><td>{5}</td><td>{3}</td><td></td></tr>';for(var i=0,len=a.length;i<len;i++)li.push(String.format.apply(null,[format].concat(a[i])));if(a.length==1)selectedPartner($(li[0]));else o.tbl.find("tbody").html(li)})};o.show=function(callbk,filter,type){ini();callback=callbk;o.dv.modal({backdrop:false});getPartner(filter||"",filter)};return o}();
agent.partnerLovTree=function(){var o=$.extend({},gobj,{dvId:"dvPartnerLovTree"}),callback,ini=function(){if(!o.dv){o.preIni();o.tbl.find("tbody tr l").live("click",function(){selectedPartner($(this))});o.dv.modal({backdrop:false});o.dv.on("hidden",function(){callback?callback():null})}},selectedPartner=function(l){var data=JSON.parse($(l).attr("data"));var p={};p.id=data[1];p.code=data[2];p.name=data[3];p.uname=data[6];p.mobile=data[7];callback?callback(p):null},getPartner=function(code){if(o.tbl.find("tbody tr").size()>
0)return;gf.noPagination("up_member_getAgentTree1",[ur.user().agentId,code||""],function(b){var li=[],format="<tr id={1} rank={4} class='{5}'><td><l data='{8}'>[{2}]{3}</l></td></tr>";for(var i=0,len=b.length;i<len;i++){var a=b[i];a[5]=a[4]==a[5]?"":"child-of-"+a[0];a[2]=a[2]||"";a.push(JSON.stringify(a));li.push(String.format.apply(null,[format].concat(a)))}o.tbl.find("tbody").html(li.join(""));o.tbl.treeTable({indent:19})})};o.show=function(callbk){ini();callback=callbk;o.dv.modal("show");getPartner()};
return o}();
agent.config=function(){var o={dv:null,dvId:"dvConfig",fmPwd:null,fmInfo:null},ini=function(){if(!o.dv){o.dv=$("#dvConfig");o.fmPwd=o.dv.find(".pwd");o.fmInfo=o.dv.find(".info");o.pwdInputs=o.fmPwd.find("input");o.infoInputs=o.fmInfo.find("input");o.infoInputs.eq(1).click();o.fmPwd.find("button").click(function(){changpwd();return false});o.fmInfo.find("button").click(function(){changInfo();return false});gf.getOneLine("up_member_getInfo",[ur.user().agentId],function(a){o.infoInputs.eq(0).val(a[0]);if(a[1]!=
"SaleOut")o.infoInputs.eq(2).click()})}},changpwd=function(){if(o.pwdInputs.eq(1).val()!=o.pwdInputs.eq(2).val()){gtips.showNotice("\u4e24\u6b21\u5bc6\u7801\u8f93\u5165\u4e0d\u4e00\u81f4\uff01");return}gf.callProc_with_value("up_member_changPwd",[ur.user().id,o.pwdInputs.eq(0).val(),o.pwdInputs.eq(1).val()],function(o){if(o===0)gtips.showNotice("\u539f\u59cb\u5bc6\u7801");else{alert("\u5bc6\u7801\u66f4\u6539\u6210\u529f,\u5c06\u91cd\u65b0\u767b\u9646\uff01");window.location="/shop/my_account.shtml"}})},
changInfo=function(){var stocktype=o.fmInfo.find(":radio:checked").val();gf.callProc_with_value("up_member_updInfo",[ur.user().id,ur.user().agentId,o.infoInputs.eq(0).val(),stocktype],function(o){alert("\u4fee\u6539\u6210\u529f\uff01")})};base.iniFunc[o.dvId]={fun:ini}}();
agent.member=function(){var o=$.extend({},_cmbAddress,gobj,gpagination,{id:"",agentId:"",fields:"ID,memberNo,name,companyName,address,mobile,total_point,consumed_point,IdCardNo,DistrictCode,memberDate,gender,role,CREATION_DATE,rank",ttbl:"member.users_v2",fileNamePrefix:"memberlist",toexcel_fields:"ID,memberNo,name,companyName,address,mobile,IdCardNo,memberDate,gender",dvUpdate:null,dvId:"dvMembers"}),ini=function(){if(!o.dv){var om=o;o.preIni();o.dvUpdate=$("#dvUpdateMember");o.cmbAddress=o.dvUpdate.find(".address select");
o.dvUpdate.find(".icon_close").click(function(){om.dvUpdate.fadeOut()});o.oTbl=o.dv.find("table");o.bttnSearch=o.dv.find(".vehicle_search [name=query]").click(function(){o.search()});o.dvUpdate.find(".btnSave").click(function(){var a=[];a.push(ur.user().id);a.push(om.id);a.push(om.parentId);a.push(om.cmbAddress.eq(2).val());var btn=$(this).val("\u6b63\u5728\u6dfb\u52a0");om.dvUpdate.find(".content table td :text").each(function(){a.push($(this).val())});gf.callProc("",a,function(){gtips.showNotice("\u6dfb\u52a0\u5b8c\u6bd5!");
btn.val("\u786e\u5b9a\u4fdd\u5b58");om.dvUpdate.fadeOut()})})}},show=function(obj,parentName,parentId,id){this.iniAddr();var o=this.dvUpdate.find("table td");o.eq(0).text(parentName);gf.show(obj,this.dvUpdate,{x:"center",y:"center"});this.id="";this.parentId=parentId;if(id)this.id=id};o.fdata=function(a){var c=[];c.push(dom.td(""));c.push(dom.td(a[1]));c.push(dom.td(a[2]));c.push(dom.td(a[8].substr(0,a[8].length-4)+"****"));c.push(dom.td(a[5]));c.push(dom.td(a[6]));c.push(dom.td(a[7]));c.push(dom.td(Number(a[6])-
Number(a[7])));c.push(dom.td(0));c.push(dom.td(a[3]));return dom.tr(c.join(""),'_id="'+a[0]+'"')};o.where=function(){var a=[],aF=[];aF.push("role=r_r");aF.push("code like 'r_r%'");aF.push("memberNo='r_r'");aF.push("IdCardNo='r_r'");aF.push("mobile='r_r'");aF.push("name like 'r_r%'");a.push("11");a.push(ur.user().code);this.dv.find(".vehicle_search").find(":text,select").each(function(){a.push($(this).val())});return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]={fun:ini}}();
agent.memberSta=function(){var o=$.extend({},gobj,{dvId:"dvMemberSta"}),ini=function(){if(!o.dv){o.preIni();iniMonth()}},iniMonth=function(){var opt=[];opt.push("<option></option>");for(var i=0;i<12;i++)opt.push('<option value="'+(i+1)+'"> '+(i+1)+"\u6708</option>");o.dv.find(".month").change(function(){var s=(new Date).getFullYear()+"-"+$(this).val()+"-1",e=(new Date).getFullYear()+"-"+(parseInt($(this).val())+1)+"-1";if($(this).val()==12)e=(new Date).getFullYear()+1+"-1-1";if(!$(this).val()){s=
"";e=""}o.dv.find(".date :text").eq(0).val(s).end().eq(1).val(e)}).html(opt.join(""))};o.search=function(idx,obj){var a=[],format="_id={0} id={0} rank={1} class='{2}'";var inputs=o.dv.find(":text");a[0]=inputs.eq(0).attr("_id");if(!a[0])a[0]=ur.user().agentId;if(inputs.eq(0).val().indexOf(ur.user().code)!=0||inputs.eq(0).val()=="")a[1]=ur.user().code;else a[1]=inputs.eq(0).val();a[2]=inputs.eq(1).val();a[3]=inputs.eq(2).val();if(a[2]&&a[3]){var btn=$(obj).disable().val("\u6b63\u5728\u7edf\u8ba1..");
gtips.showAjax();gf.noPagination("up_member_staUser3",a,function(a){btn.enable().val("\u7edf\u8ba1");var b=[],c=[];for(var i=0;i<a.length;i++){b=a[i];c.push(dom.td(b[0]));c.push(dom.td(b[1]));c.push(dom.td(b[2]));c.push(dom.td(gf.percent(b[1],b[2])));b[4]=b[5]==b[6]?-1:b[4];a[i]=dom.tr(c.join(""),String.format(format,b[3],b[5],b[4]<0?"":"child-of-"+b[4]));c=[]}o.tbl.find("tbody").html(a.join(""));o.tbl.treeTable({indent:19});o.searchend(a.length);gtips.hideAjax()})}else gtips.showNotice("\u8bf7\u9009\u62e9\u65f6\u95f4\u8303\u56f4")};
base.iniFunc[o.dvId]={fun:ini};return o}();
agent.memberStaGroup=function(){var o=$.extend({},gobj,{dvId:"dvMemberStaGroup"}),ini=function(){if(!o.dv){o.preIni();iniMonth()}},iniMonth=function(){var opt=[];opt.push("<option></option>");for(var i=0;i<12;i++)opt.push('<option value="'+(i+1)+'"> '+(i+1)+"\u6708</option>");o.dv.find(".month").change(function(){var s=(new Date).getFullYear()+"-"+$(this).val()+"-1",e=(new Date).getFullYear()+"-"+(parseInt($(this).val())+1)+"-1";if($(this).val()==12)e=(new Date).getFullYear()+1+"-1-1";if(!$(this).val()){s=
"";e=""}o.dv.find(".date :text").eq(0).val(s).end().eq(1).val(e)}).html(opt.join(""))};o.search=function(idx,obj){var a=[],format="data-id={0} id={0} rank={1} class='{2}'";var inputs=o.dv.find(":text");a[0]=inputs.eq(0).attr("_id");if(!a[0])a[0]=ur.user().agentId;a[1]=inputs.eq(1).val();a[2]=inputs.eq(2).val();if(a[1]&&a[2]){var btn=$(obj).disable().val("\u6b63\u5728\u7edf\u8ba1..");gtips.showAjax();gf.noPagination("up_member_getMemberActivityGroup",a,function(a){btn.enable().val("\u7edf\u8ba1");
var b=[],c=[];for(var i=0;i<a.length;i++){b=a[i];c.push(dom.td(b[0]));c.push(dom.td("["+b[1]+"]"+b[2]));c.push(dom.td(b[3]));a[i]=dom.tr(c.join(""),String.format(format,b[4],1,b[4]>0?"":"child-of-"+b[5]));c=[]}o.tbl.find("tbody").html(a.join(""));o.tbl.treeTable({indent:19});o.searchend(a.length);gtips.hideAjax()})}else gtips.showNotice("\u8bf7\u9009\u62e9\u65f6\u95f4\u8303\u56f4")};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.saleAnaylyse=function(){var o=$.extend({},gobj,{dvId:"dvSoAnalyse"}),ini=function(){if(!o.dv){o.preIni();iniMonth()}},iniMonth=function(){var opt=[];opt.push("<option></option>");for(var i=0;i<12;i++)opt.push('<option value="'+(i+1)+'"> '+(i+1)+"\u6708</option>");o.dv.find(".month").change(function(){var s=(new Date).getFullYear()+"-"+$(this).val()+"-1",e=(new Date).getFullYear()+"-"+(parseInt($(this).val())+1)+"-1";if($(this).val()==12)e=(new Date).getFullYear()+1+"-1-1";if(!$(this).val()){s=
"";e=""}o.dv.find(".date :text").eq(0).val(s).end().eq(1).val(e)}).html(opt.join(""))};o.search=function(idx,obj){var a=[],format="_id={0} id={0} rank={1} class='{2}'";var inputs=o.dv.find(":text");a[0]=ur.user().agentId;a[1]=inputs.eq(0).val();a[2]=inputs.eq(1).val();a[3]=o.dv.find("select:eq(1)").val();if(a[1]&&a[2]){var btn=$(obj).disable().val("\u6b63\u5728\u5206\u6790..");gtips.showAjax();gf.query("agent.base.soAnalytic",a,function(a){btn.enable().val("\u7edf\u8ba1");var b=[],c=[],totalAmount=
0,totalQty=0;for(var i=0;i<a.length;i++){b=a[i];c.push(dom.td(i+1));c.push(dom.td(b[0]));c.push(dom.td('<label class=number style="width:50%">'+f.price(b[1],2)+"</label>"));c.push(dom.td(b[2]));a[i]=dom.tr(c.join(""));totalAmount+=b[1];totalQty+=b[2];c=[]}o.tbl.find("tbody").html(a.join("")).end().find("tfoot").find("th").eq(1).html('<label class=number style="width:50%">'+f.price(totalAmount,2)+"</label>").end().eq(2).text(totalQty);o.searchend(a.length);gtips.hideAjax()})}else gtips.showNotice("\u8bf7\u9009\u62e9\u65f6\u95f4\u8303\u56f4")};
base.iniFunc[o.dvId]={fun:ini};return o}();
agent.soReturnAnaylyse=function(){var o=$.extend({},gobj,{dvId:"dvSoReturnAnalyse"}),ini=function(){if(!o.dv){o.preIni();iniMonth()}},iniMonth=function(){var opt=[];opt.push("<option></option>");for(var i=0;i<12;i++)opt.push('<option value="'+(i+1)+'"> '+(i+1)+"\u6708</option>");o.dv.find(".month").change(function(){var s=(new Date).getFullYear()+"-"+$(this).val()+"-1",e=(new Date).getFullYear()+"-"+(parseInt($(this).val())+1)+"-1";if($(this).val()==12)e=(new Date).getFullYear()+1+"-1-1";if(!$(this).val()){s=
"";e=""}o.dv.find(".date :text").eq(0).val(s).end().eq(1).val(e)}).html(opt.join(""))};o.search=function(idx,obj){var a=[],format="_id={0} id={0} rank={1} class='{2}'";var inputs=o.dv.find(":text");a[0]=ur.user().agentId;a[1]=inputs.eq(0).val();a[2]=inputs.eq(1).val();a[3]=o.dv.find("select:eq(1)").val();if(a[1]&&a[2]){var btn=$(obj).disable().val("\u6b63\u5728\u5206\u6790..");gtips.showAjax();gf.query("agent.base.soReturnAnalytic",a,function(a){btn.enable().val("\u7edf\u8ba1");var b=[],c=[];for(var i=
0;i<a.length;i++){b=a[i];c.push(dom.td(i+1));c.push(dom.td(b[0]));c.push(dom.td('<label class=number style="width:50%">'+f.price(b[1],2)+"</label>"));c.push(dom.td(b[2]));a[i]=dom.tr(c.join(""));c=[]}o.tbl.find("tbody").html(a.join(""));o.tbl.treeTable({indent:19});o.searchend(a.length);gtips.hideAjax()})}else gtips.showNotice("\u8bf7\u9009\u62e9\u65f6\u95f4\u8303\u56f4")};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.stockinAnalyse=function(){var o=$.extend({},gobj,{dvId:"dvStockinAnalyse"}),ini=function(){if(!o.dv){o.preIni();iniMonth()}},iniMonth=function(){var opt=[];opt.push("<option></option>");for(var i=0;i<12;i++)opt.push('<option value="'+(i+1)+'"> '+(i+1)+"\u6708</option>");o.dv.find(".month").change(function(){var s=(new Date).getFullYear()+"-"+$(this).val()+"-1",e=(new Date).getFullYear()+"-"+(parseInt($(this).val())+1)+"-1";if($(this).val()==12)e=(new Date).getFullYear()+1+"-1-1";if(!$(this).val()){s=
"";e=""}o.dv.find(".date :text").eq(0).val(s).end().eq(1).val(e)}).html(opt.join(""))};o.search=function(idx,obj){var a=[],format="_id={0} id={0} rank={1} class='{2}'";var inputs=o.dv.find(":text");a[0]=ur.user().agentId;a[1]=inputs.eq(0).val();a[2]=inputs.eq(1).val();a[3]=o.dv.find("select:eq(1)").val();if(a[1]&&a[2]){var btn=$(obj).disable().val("\u6b63\u5728\u5206\u6790..");gtips.showAjax();gf.query("agent.base.stockInSta",a,function(a){btn.enable().val("\u7edf\u8ba1");var b=[],c=[];for(var i=
0;i<a.length;i++){b=a[i];c.push(dom.td(i+1));c.push(dom.td(b[0]));c.push(dom.td('<label class=number style="width:50%">'+f.price(b[1],2)+"</label>"));a[i]=dom.tr(c.join(""));c=[]}o.tbl.find("tbody").html(a.join(""));o.tbl.treeTable({indent:19});o.searchend(a.length);gtips.hideAjax()})}else gtips.showNotice("\u8bf7\u9009\u62e9\u65f6\u95f4\u8303\u56f4")};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.prodStock=function(){var o=$.extend({},gobj,gpagination,{fields:"id,name,code,category,standPrice,price,qty,uom,description,storepid,attr1Text,attr2Text",ttbl:"member.storeProduct_v",dvId:"dvProdStock"}),_displayStandPrice=true,_totalSubPrice=0,_totalQty=0,iniAttrDefin=function(){if(ur.config().attributeDefin)for(k in ur.config().attributeDefin.product){var t=o.tbl.find("thead ."+k).show(),pa=ur.config().attributeDefin.product[k];t.find("a").text(pa.label)}},iniRole=function(){var st=o.tbl.find("thead th").eq(3),
sf=o.tbl.find("tfoot th").eq(1);_displayStandPrice=false;if(ur.config().attributeDefin){if(!ur.config().attributeDefin.role)_displayStandPrice=true;for(k in ur.config().attributeDefin.role)if(ur.config().attributeDefin.role[k].id==base.STATIC.ROLE_BUYER||ur.config().attributeDefin.role[k].id==base.STATIC.ROLE_MANAGER){st.show().parent().prev().show();sf.show().next().show();_displayStandPrice=true;break}else{st.hide().parent().prev().hide();sf.hide().next().hide()}}o.displayStandPrice=_displayStandPrice},
ini=function(){if(!o.dv){o.preIni();o.dvSp.find("[name=add]").click(function(){agent.prodUpd.show()});gf.noPagination("up_member_getStoreCategoryForCmb",[1,ur.user().agentId],function(a){gOption.foption(o.dv.find(".cmbCategory").eq(0),a,-1,["",""]);gOption.foption(o.dv.next().find(".cmbCategory").eq(0),a)});o.tbl.find("tbody tr a").live("click",function(){agent.prodUpd.show($(this).parents("tr").attr("data-id"))});iniAttrDefin();iniRole()}};o.where=function(){var a=[],aF=[];aF.push("storeID=r_r");
aF.push("code like 'r_r%'");aF.push("name like 'r_r%'");aF.push("categoryID = 'r_r'");a.push(ur.user().agentId);var inputs=o.dvSp.find(".well").find("input,select");a.push(inputs.eq(0).val());a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td('<a href="#">'+a[1]+"</a>"));c.push(dom.td(a[2]));c.push(dom.td(a[3]));if(_displayStandPrice)c.push(dom.td('<label class=number style="width:50%">'+f.price(a[4],2)+"</label>"));else c.push(dom.td("",
'style="display:none;"'));c.push(dom.td('<label class=number style="width:50%">'+f.price(a[5],2)+"</label>"));if(o.tbl.find("thead th:eq(5)").css("display")!="none")c.push(dom.td(a[10]));else c.push(dom.td("",'style="display:none;"'));if(o.tbl.find("thead th:eq(6)").css("display")!="none")c.push(dom.td(a[11]));else c.push(dom.td("",'style="display:none;"'));c.push(dom.td(a[6],"class=number"));c.push(dom.td("<small>"+a[7]+"</small>"));c.push(dom.td(f.price(a[5]*a[6],2),'class="number"'));c.push(dom.td(a[8]));
c.push(dom.td(""));_totalSubPrice+=a[5]*a[6];_totalQty+=a[6];return dom.tr(c.join(""),'data-id="'+a[9]+'"')};o.ended=function(){o.tbl.find("tfoot th").eq(5).text(f.price(_totalSubPrice,2)).end().eq(3).text(_totalQty);_totalQty=0;_totalSubPrice=0};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.prodUpd=function(){var o=$.extend({},gobj,{dvId:"dvProdUpd",inputs:[],hasImg:false,parentObj:agent.prodStock}),iniAttrDefin=function(){if(ur.config().attributeDefin)for(k in ur.config().attributeDefin.product){var t=o.dv.find("."+k).show(),pa=ur.config().attributeDefin.product[k];t.first().text(pa.label);var i=t.find("input").attr({"data-ad-id":pa.id,"placeholder":pa.desc,"title":pa.desc});suggest.attribute(i)}},iniRole=function(){var st=o.inputs.eq(8);if(o.parentObj.displayStandPrice)st.show().parent().prev().show();
else st.hide().parent().prev().hide()},ini=function(){if(!o.dv){o.preIni();var file=o.dv.find(":file").change(function(){aac.cam.getImg();o.hasImg=true});o.inputs=o.dv.find("table input:not([type=file]),table textarea,table select");o.dv.find(".btnFile").click(function(){file.click()});aac.cam.ini({canvas:"c"});o.dv.find(".btnCam").click(function(){camClick(this)});o.inputs.eq(2).keyup(function(){o.inputs.eq(3).val(aac.makePy($(this).val()))});o.dv.find(".close").click(function(){aac.cam.stopCam()});
iniAttrDefin();iniRole()}},camClick=function(obj){if(aac.cam.status==aac.cam.PLAYING){aac.cam.parseCam();o.hasImg=true;$(obj).find("c").html("\u91cd\u65b0\u6444\u53d6")}else{aac.cam.startCam();$(obj).find("c").html("\u62cd\u7167")}},clear=function(){o.inputs.eq(0).val(-1);for(var i=1;i<o.inputs.length;i++)o.inputs.eq(i).val("")},close=function(){o.dv.modal("hide");agent.prodStock.search()},save=function(a,success){gf.callProc_with_value("up_member_updateProductAttr",a,function(v){if(v<0)gtips.showNotice("\u5b58\u5728\u76f8\u540c\u7684\u4ea7\u54c1");
else{gtips.showNotice("\u4fdd\u5b58\u6210\u529f");success?success():null}})},submit=function(success){var a=[],inputs=o.inputs;for(var i=0,b=null;b=inputs[i];i++){if($(b).attr("data-ad-id"))a.push($(b).attr("data-ad-id"));a.push($(b).val())}a.push(ur.user().id);a.push(ur.user().agentId);if(o.hasImg)aac.cam.upload(function(filePath){a.push(filePath.substring(0,filePath.lastIndexOf("\\")+1));a.push(filePath.substring(filePath.lastIndexOf("\\")+1));save(a,success)});else{a.push("");a.push("");save(a,
success)}},getProduct=function(id){gf.getOneLineSqlPara("storepid="+id,"storepid,categoryID,name,code,barcode,qty,uomid,price,standPrice,attr1text,attr2text,description,imgUrl","member.storeProduct_v",function(a){var j=0,inputs=o.inputs;for(var i=0,b=null;b=inputs[i];i++)a.push($(b).val(a[i]));if(a[12])aac.cam.getImg(a[12])})};o.saveAdd=function(){submit(clear)};o.saveClose=function(){submit(function(){clear();close()})};o.show=function(id){ini();o.dv.modal({});var t="";if(id){t="\u4fee\u6539";getProduct(id)}else{t=
"\u521b\u5efa";clear()}o.dv.find(".modal-header c").html(t)};return o}();
agent.customer=function(){var o=$.extend({},gobj,gpagination,{dvId:"dvCustomer",ttbl:"[user].[customer_v1]",fields:"ID,code,rank,name,uname,mobile,street,note,parentName,CREATION_DATE,memberQty,DistrictCode,userQty,storeId,discount,isVendor,isCustomer,isChain"}),ini=function(){if(!o.dv){o.preIni();o.dvSp.find("button[name=add]").click(function(){agent.partnerUpd.show(null,null,"customer")});o.dv.find("tbody").find("a").live("click",function(){agent.partnerUpd.show($(this).attr("data-id"),$(this).parents("tr").attr("data"),
"customer")})}};o.fdata=function(a){var c=[],format="_id={0} data-id={0} districtcode={1} rank={2} code='{3}' class='{4}' data='{4}'";c.push(dom.td(dom.a(a[1],"#","data-id="+a[0])));c.push(dom.td(a[3]));c.push(dom.td(a[14]));c.push(dom.td(a[4]));c.push(dom.td(a[5]));c.push(dom.td(a[6]));c.push(dom.td(a[7]));if(a[11]==a[2])a[10]=-1;return dom.tr(c.join(""),String.format(format,a[0],a[8],a[2],a[1],encodeURI(JSON.stringify(a))))};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("rank=r_r");
aF.push("DistrictCode like 'r_r%'");aF.push("hgift > r_r");a[0]=ur.user().agentId;return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.partnerUpd=function(){var o=$.extend({},_cmbAddress,{dv:null}),ini=function(){if(!o.dv){o.dv=$("#dvPartnerUpd");o.dv.find(".btn-success").click(function(){save(function(){o.dv.modal("hide");clear();agent.customer.search()})}).find(".btn-save-add").click(function(){save(function(){clear();agent[o.type].search()})});o.cmbAddress=o.dv.find(".address select");o.dv.find(".modal-body table td:eq(0)").find("input").blur(function(){if($(this).val().length==3)$(this).removeClass("error");else $(this).addClass("error")});
o.iniAddr()}},clear=function(){o.id=null;o.dv.find("input").val("")},save=function(success){var a=[],tds=o.dv.find(".modal-body table td");a.push(ur.user().id);a.push(o.id||0);a.push(ur.user().agentId);var code=tds.eq(0).find("input");a.push(o.cmbAddress.eq(2).val());a.push(code.val());tds.eq(1).find("label").each(function(){a.push($(this).find(":checked").size())});a.push(tds.eq(2).find("input").val());a.push(tds.eq(3).find("input").val());a.push(tds.eq(4).find("input").val());a.push(tds.eq(5).find("input").val());
a.push(tds.eq(7).find("input").val());gf.getOneLine("up_user_updatePartner",a,function(v){if(v[0]){alert("\u66f4\u65b0\u6210\u529f\uff01\u8bf7\u8bb0\u4f4f\u7f16\u53f7"+v[0]);if(success)success()}else{alert("\u66f4\u65b0\u6210\u529f\uff01");if(success)success()}})},fdata=function(a){var tds=o.dv.find("td");tds.eq(0).find("input").val(a[1]);tds.eq(1).find("input").each(function(i){if(a[15+i]>0)$(this).attr("checked","checked");else $(this).removeAttr("checked")});tds.eq(2).find("input").val(a[3]);tds.eq(3).find("input").val(a[4]);
tds.eq(4).find("input").val(a[14]);tds.eq(5).find("input").val(a[5]);tds.eq(7).find("input").val(a[6]);o.setDefault(a[11])};o.show=function(id,a,type){ini();o.dv.modal({});o.type=type;var tds=o.dv.find(".modal-body table td");o.dv.find(".modal-header c").text("\u6dfb\u52a0");if(id){o.id=id;fdata(JSON.parse(decodeURI(a)));o.dv.find(".modal-header c").text("\u4fee\u6539")}};return o}();
agent.customerUpd=function(){var o=$.extend({},_cmbAddress,{dv:null}),ini=function(){if(!o.dv){o.dv=$("#dvCustomerUpd");o.dv.find(".btn-success").click(function(){save(function(){o.dv.modal("hide");clear();agent.customer.search()})}).find(".btn-save-add").click(function(){save(function(){clear();agent.customer.search()})});o.cmbAddress=o.dv.find(".address select");o.dv.find(".modal-body table td:eq(0)").find("input").blur(function(){if($(this).val().length==3)$(this).removeClass("error");else $(this).addClass("error")});
o.iniAddr()}},clear=function(){o.id=null;o.dv.find("input").val("")},save=function(success){var a=[],tds=o.dv.find(".modal-body table td");a.push(ur.user().id);a.push(o.id||0);a.push(ur.user().agentId);var code=tds.eq(0).find("input");if(code.val().length!=3){code.addClass("error");return}a.push(o.cmbAddress.eq(2).val());a.push(ur.user().code+code.val());a.push(tds.eq(1).find("input").val());a.push(tds.eq(2).find("input").val());a.push(tds.eq(3).find("input").val());a.push(tds.eq(4).find("input").val());
a.push(tds.eq(6).find("input").val());gf.callProc_with_value("up_member_updateAgent2",a,function(v){if(v==0)alert("\u7f16\u53f7\u5b58\u5728\uff01");else{alert("\u66f4\u65b0\u6210\u529f\uff01");if(success)success()}})},fdata=function(a){var inputs=o.dv.find("input");inputs.eq(0).val(a[1].substr(ur.user().code.length));inputs.eq(1).val(a[3]);inputs.eq(2).val(a[14]);inputs.eq(3).val(a[4]);inputs.eq(4).val(a[5]);inputs.eq(5).val(a[6]);o.setDefault(a[11])};o.show=function(id,a){ini();o.dv.modal({});var tds=
o.dv.find(".modal-body table td");tds.eq(0).find("c").text(ur.user().code);o.dv.find(".modal-header c").text("\u6dfb\u52a0");if(id){o.id=id;fdata(JSON.parse(decodeURI(a)));o.dv.find(".modal-header c").text("\u4fee\u6539")}};return o}();
agent.vendor=function(){var o=$.extend({},gobj,gpagination,{dvId:"dvVendor",ttbl:"[user].vendor_v",fields:"ID,code,rank,name,uname,mobile,street,note,parentName,CREATION_DATE,memberQty,DistrictCode,userQty,storeId,discount"}),ini=function(){if(!o.dv){o.preIni();o.dvSp.find("button[name=add]").click(function(){agent.vendorUpd.show()});o.dv.find("tbody").find("a").live("click",function(){agent.vendorUpd.show($(this).attr("data-id"),$(this).parents("tr").attr("data"))})}};o.fdata=function(a){var c=[],
format="_id={0} data-id={0} districtcode={1} rank={2} code='{3}' class='{4}' data='{4}'";c.push(dom.td(dom.a(a[1],"#","data-id="+a[0])));c.push(dom.td(a[3]));c.push(dom.td(a[4]));c.push(dom.td(a[5]));c.push(dom.td(a[6]));c.push(dom.td(a[7]));if(a[11]==a[2])a[10]=-1;return dom.tr(c.join(""),String.format(format,a[0],a[8],a[2],a[1],encodeURI(JSON.stringify(a))))};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("rank=r_r");aF.push("DistrictCode like 'r_r%'");aF.push("hgift > r_r");a[0]=
ur.user().agentId;return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.vendorUpd=function(){var o=$.extend({},_cmbAddress,{dv:null}),ini=function(){if(!o.dv){o.dv=$("#dvVendorUpd");o.dv.find(".btn-success").click(function(){save(function(){o.dv.modal("hide");clear();agent.customer.search()})}).find(".btn-save-add").click(function(){save(function(){clear();agent.vendor.search()})});o.cmbAddress=o.dv.find(".address select");o.dv.find(".modal-body table td:eq(0)").find("input").blur(function(){if($(this).val().length==3)$(this).removeClass("error");else $(this).addClass("error")});
o.iniAddr()}},clear=function(){o.id=null;o.dv.find("input").val("")},save=function(success){var a=[],tds=o.dv.find(".modal-body table td");a.push(ur.user().id);a.push(o.id||0);a.push(ur.user().agentId);var code=tds.eq(0).find("input");a.push(o.cmbAddress.eq(2).val());a.push(code.val());a.push(tds.eq(1).find("input").val());a.push(tds.eq(2).find("input").val());a.push(tds.eq(3).find("input").val());a.push(tds.eq(5).find("input").val());gf.getOneLine("up_user_updateVendor",a,function(v){if(v[0]){alert("\u66f4\u65b0\u6210\u529f\uff01\u8bf7\u8bb0\u4f4f\u7f16\u53f7"+
v[0]);if(success)success()}else{alert("\u66f4\u65b0\u6210\u529f\uff01");if(success)success()}})},fdata=function(a){var inputs=o.dv.find("input");inputs.eq(0).val(a[1]);inputs.eq(1).val(a[3]);inputs.eq(2).val(a[4]);inputs.eq(3).val(a[5]);inputs.eq(4).val(a[6]);o.setDefault(a[11])};o.show=function(id,a){ini();o.dv.modal({});var tds=o.dv.find(".modal-body table td");tds.eq(0).find("c").text(ur.user().code);o.dv.find(".modal-header c").text("\u6dfb\u52a0");if(id){o.id=id;fdata(JSON.parse(decodeURI(a)));
o.dv.find(".modal-header c").text("\u4fee\u6539")}};return o}();
agent.poReturn=function(){var o=$.extend({},gobj,gpagination,{ttbl:"member.poReturnHead_v",fields:"id,orderNumber,orderDate,member,saler,amount,saleConfirmDate,aname,note,status,rname",dvId:"dvPoReturn"}),ini=function(){if(!o.dv){o.preIni();o.dvSp.find("[name=add]").click(function(){agent.poReturnUpd.show()});o.tbl.find("tbody tr a").live("click",function(){agent.poReturnUpd.show($(this).parents("tr").attr("data-id"))})}},updateStatus=function(id,status){gf.callProc_with_value("up_agent_updateSoStatus",
[id,status,ur.user().id],function(){o.search()})},dropdownClick=function(obj){var id=$(obj).parents("tr").attr("data-id");switch($(obj).attr("for")){case "ddprint":o.printSo(id);break;case "ddview":agent.soReturnUpd.show(id,"view");break;case "ddedit":agent.soReturnUpd.show(id,"edit");break;case "ddconfirm":updateStatus(id,"confirm");break;case "ddcancel":updateStatus(id,"cancel");break}};o.ended=function(){o.tbl.find(".dropdown-menu li:has(a)").click(function(){dropdownClick($(this))})};o.printSo=
function(id){var doc=$(frames["ptso"].document).find("div");doc.find("table:visible").remove();var tbl=doc.find("table").clone();tbl.show().appendTo(doc);var trs=tbl.find("tbody tr"),title=trs.eq(0),header=trs.eq(1),date=trs.eq(2),customer=trs.eq(3),comment=trs.eq(4),line=trs.eq(6),xj=trs.eq(7),hj=trs.eq(8),dx=trs.eq(9),a=o.data[id];title.find("td").text(ur.user().coName);header.find("td").text("\u9000\u8d27\u5355");date.find("td c").eq(0).text(f.date(a[2])).end().eq(1).text(a[1]);customer.find("td c").eq(0).text(a[3]).end().eq(1).text(a[7]);
comment.find("td c").text(a[8]),tqty=0,tamount=0,tdis=0;gf.noPagination("up_member_getSoLine",[id],function(a){var tds=[];for(var i=0,b=[];b=a[i];i++){if(i==0)tds=line.find("td");else{var cl=line.clone();cl.insertBefore(xj);tds=cl.find("td");tds.eq(0).text(i+1)}b[4]=b[4]*-1;tds.eq(1).text(b[9]);tds.eq(2).text(b[1]);tds.eq(3).text(b[3]);tds.eq(4).text(f.price(b[2],2));tds.eq(5).text(b[4]);tqty+=b[4];tds.eq(6).text(f.price(b[2]*b[4],2));tdis+=b[2]*b[4]*b[5]/100;tds.eq(8).text(f.price(b[2]*b[4]*(100-
b[5])/100,2));tamount+=b[2]*b[4]*(100-b[5])/100}xj.find("td").eq(1).text(tqty).end().eq(3).text(f.price(tamount,2));hj.find("td c").eq(0).text(tqty).end().eq(1).text(f.price(tamount,2)).end().eq(2).text(f.price(tdis,2));dx.find("td c").text(f.chineseNumber(tamount));frames["ptso"].print()})};o.where=function(){var a=[],aF=[];aF.push("storeID=r_r");aF.push("orderNumber like '%r_r%'");aF.push("orderDate>= 'r_r'");aF.push("orderDate<= 'r_r'");aF.push("status = 'r_r'");a.push(ur.user().agentId);var inputs=
o.dvSp.find("input,select");a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());a.push(inputs.eq(3).val());a.push(inputs.eq(4).val());return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(dom.a(a[1],"#")));c.push(dom.td(f.date(a[2])));c.push(dom.td(a[7]+"["+a[3]+"]"));c.push(dom.td(a[4]));c.push(dom.td('<label class=number style="width:50%">'+f.price(a[5],2)+"</label>"));c.push(dom.td(a[10]));var stat="",stat2="",stat3="";if(a[9]=="cancel")stat="\u5df2\u53d6\u6d88";else{stat=
a[6]&&f.date(a[6]);if(a[9]=="draft"||a[9]==""){stat="\u8349\u7a3f";stat3='  <li class="" for="ddconfirm"><a href="#"><i class="icon-ok-sign"></i>\u786e\u8ba4</a></li>'+'  <li class="" for="ddcancel"><a href="#"><i class="icon-remove-circle"></i>\u53d6\u6d88</a></li>';stat2='  <li class="" for="ddedit"><a href="#"><i class="icon-pencil"></i>\u4fee\u6539</a></li>'}}c.push(dom.td(stat));var b=[["\u4fee\u6539","update"],["\u67e5\u770b","view"]];b=!!a[6]?b[1]:b[0];var dd='<td class="dropdown navbar">'+
'<a href="#" class="dropdown-toggle" data-toggle="dropdown">\u64cd\u4f5c<b class="caret"></b></a>'+' <ul class="dropdown-menu">'+'  <li class="" for="ddview"><a href="#"><i class="icon-file"></i>\u67e5\u770b</a></li>'+stat2+'  <li for="ddprint"><a href="#"><i class="icon-print"></i>\u6253\u5370</a></li>'+'  <li class="divider"></li> '+stat3+"</ul></td>";c.push(dd);o.data[a[0]]=a;return dom.tr(c.join(""),'data-id="'+a[0]+'"')};o.updateStatus=updateStatus;base.iniFunc[o.dvId]={fun:ini,obj:o};return o}();
agent.poReturnUpd=function(){var o=$.extend({},gobj,base.poUpd,{dvId:"dvPoReturnUpd",inputs:[],status:{cancel:"\u53d6\u6d88",confirm:"\u5df2\u786e\u8ba4",draft:"\u8349\u7a3f"}}),ini=function(){if(!o.dv){o.preIni();o.dv.find("button[name=query]").click(function(){agent.soProductQuery.show(selectedProduct,ur.user().id,o.partner.attr("data-id"))});o.dv.find("button[name=clear]").click(function(){clear()});o.partner=o.dv.find("#q_po_ru_partner").next().click(function(){agent.partnerMemberLov.show(fillPartner,
o.partner.val(),"customer")}).end().blur(function(){$(this).val($(this).attr("data-code")||""+" "+($(this).attr("data-name")||""))}).focus(function(){$(this).val($(this).attr("data-code")||"")});o.tbl.find("tbody tr td[contenteditable]").live("blur",function(){$(this).parents("tr").addClass("dirty");pressEnter(this)}).live("keypress",function(evt){if(evt.keyCode==13){pressEnter(this);return false}});o.tbl.find("tbody tr td .del").live("click",function(){delTr(this)});o.dv.find(".result-header button[name=clear]").click(function(){clear()});
o.dv.find(".result-header .dropdown-menu li:has(a)").click(function(){clickDropMenu($(this))});o.inputs=o.dvSp.find("input,select");o.total=o.dv.find("#q_po_ru_total");o.getVendor()}},selectedProduct=function(a){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb="";delbtn=""}for(var i=0,b=null;b=a[i];i++){var td=[];td.push(dom.td(b.productName));td.push(dom.td(b.maxQty,
'class="number" '+ctb));td.push(dom.td(b.maxPrice,'class="number" '+ctb));td.push(dom.td("/"+b.uom));td.push(dom.td(b.maxQty*b.maxPrice));td.push(dom.td(b.orderNum));td.push(dom.td("",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));attr='data-maxQty="'+b.maxQty+'" data-maxPrice="'+b.maxPrice+'" data-fromId="'+b.lineId+'" data-prod-id="'+b.productId+'"';tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,
"yyyy-MM-dd HH:mm:ss"));total()},confirmOrder=function(){o.inputs.eq(4).attr("data-value","confirm");submit(function(id){agent.so.updateStatus(id,"confirm");o.show(id)})},cancelOrder=function(){o.inputs.eq(4).attr("data-value","cancel");submit()},clickDropMenu=function(obj){if(obj.hasClass("confirm"))confirmOrder();else if(obj.hasClass("cancel"))cancelOrder();else if(obj.hasClass("clear"))clear()},pressEnter=function(obj){if($(obj).hasClass("number")){var tr=$(obj).parents("tr");if($(obj).index()==
1){if(parseFloat($(obj).text())>parseFloat(tr.attr("data-maxqty"))){$(obj).text(tr.attr("data-maxqty")).focus();gtips.showNotice("\u4e0d\u80fd\u5927\u4e8e\u8ba2\u5355\u7684\u6570\u91cf");return}}else if($(obj).index()==2)if(parseFloat($(obj).text())>parseFloat(tr.attr("data-maxprice"))){$(obj).text(tr.attr("data-maxprice")).focus();gtips.showNotice("\u4e0d\u80fd\u5927\u4e8e\u8ba2\u5355\u4e0a\u9762\u7684\u5355\u4ef7");return}changeNumber(obj)}var idx=$(obj).index();$(obj).parents("tr").next().find("td").eq(idx).focus()},
changeNumber=function(obj){var tds=$(obj).parents("tr").find("td"),price=tds.eq(2).text(),num=tds.eq(1).text()||0;tds.eq(4).text(parseFloat(price)*parseInt(num));total()},total=function(){var t=0;o.tbl.find("tbody tr:not(.hide)").each(function(){t+=parseFloat($(this).find("td:eq(4)").text()||0)});o.total.val(t)},fillPartner=function(p){o.partner.val(p.code+" "+p.name).attr({"data-id":p.id,"data-code":p.code,"data-name":p.name});o.discount=p.discount},delTr=function(obj){var tr=$(obj).parents("tr");
if(tr.attr("data-id"))tr.hide().addClass("hide");else $(obj).parents("tr").remove();total()},fillProduct=function(a){fdataLine(a);total()},addSo=function(head,lines,success){gf.callProc_with_value("up_member_createSoReturnHead",head,function(v){for(var i=0,len=lines.length;i<len;i++)lines[i]=[v].concat(lines[i]);if(lines.length>0)gf.callProcBatch("up_member_createSoReturnLine",lines,function(){success(v)})})},displayBtn=function(){o.dv.find(".btn:not(.lov .btn)").hide();o.dv.find("input,textarea,.lov .btn").disable()},
showBtn=function(){o.dv.find(".btn").show();o.dv.find("input:not(#q_po_ru_total,#q_po_ru_status),textarea,.lov .btn").enable()},fdataHead=function(a){o.inputs.eq(0).val(a[0]);o.inputs.eq(1).val(a[9]+" "+a[10]).attr({"data-code":a[9],"data-name":a[10],"data-id":a[5]});o.inputs.eq(2).val(a[2]);o.inputs.eq(3).val(a[4]);o.inputs.eq(4).val(o.status[a[11]]||o.status["draft"]).attr("data-value",a[11]||"draft");if(a[11]=="cancel"||a[11]=="confirm")displayBtn();else showBtn();o.dv.find(".modal-footer textarea").text(a[8])},
fdataLine=function(a){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb="";delbtn=""}for(var i=0,b=[];b=a[i];i++){var td=[];if(o.tbl.find("tbody tr[data-prod-id="+b[0]+"]").size()>0)continue;td.push(dom.td(b[1]));td.push(dom.td(b[4]*-1||"1",'class="number" '+ctb));td.push(dom.td(b[2],'class="number" '+ctb));td.push(dom.td("<small>"+b[3]+"</small>"));td.push(dom.td(b[2]*
b[4]*parseFloat(b[5]||0-100)/100,'class="number"'));td.push(dom.td(b[10]||""));td.push(dom.td(b[6]||"",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));var attr='data-prod-id="'+b[0]+'"';if(b[7])attr+=' data-id="'+b[7]+'"';tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,"yyyy-MM-dd HH:mm:ss"))},getHead=function(id,type){gf.getOneLine("up_member_getSoReturnHead",
[id],function(a){fdataHead(a);getLine(id);o.dv.find(".modal-header h3").find("c").text(type=="view"?"\u67e5\u770b":"\u4fee\u6539").end().find("small").text("[MRT"+a[0]+"]")})},getLine=function(id){gf.noPagination("up_member_getSoLine",[id],function(a){o.tbl.find("tbody").html("");fillProduct(a)})},submit=function(success){var head=[],line=[],lines=[],om=this,uid=ur.user().id;head.push(o.inputs.eq(0).val()||0);head.push(o.inputs.eq(1).attr("data-id"));if(!o.inputs.eq(1).val()){o.inputs.eq(1).addClass("error");
return}else o.inputs.eq(1).removeClass("error");head.push(uid);head.push(o.inputs.eq(2).val());head.push(o.inputs.eq(4).val());head.push(o.inputs.eq(3).val());head.push(o.dv.find(".modal-footer textarea").text()||"");head.push(o.inputs.eq(5).attr("data-value")||"draft");head.push(uid);o.tbl.find("tbody tr").each(function(){var obj=$(this),tds=obj.find("td");line=[];if(obj.hasClass("dirty")||!obj.attr("data-id")||obj.css("display")=="none"){var id=parseInt(obj.attr("data-id")||0);if(obj.css("display")==
"none")id=-id;line.push(id);line.push(obj.attr("data-prod-id"));line.push("-"+tds.eq(1).text());line.push(tds.eq(2).text());line.push(obj.attr("data-fromId"));line.push(tds.eq(6).text());line.push(uid);lines.push(line)}});if(lines.length||head[0]>0)addSo(head,lines,success)},close=function(){o.dv.modal("hide")},clear=function(){o.tbl.find("tbody").html("");o.inputs.val("").eq(2).val(gf.dateFormat(new Date,"yyyy-MM-dd"));o.inputs.eq(5).val(o.status["draft"]).attr("data-value","draft");showBtn();o.dv.find(".modal-header h3").find("c").text("\u65b0\u589e").end().find("small").text("")};
o.show=function(id,type){ini();o.dv.modal({backdrop:"static"});if(id)getHead(id,type);else clear()};o.saveClose=function(){submit(function(){close();agent.poReturn.search()})};o.saveAdd=function(){submit(clear)};return o}();
agent.stockOut=function(){var o=$.extend({},gobj,gpagination,{dvId:"dvStockOut",ttbl:"member.stockTranOut_v",fields:"id,orderNumber,productName,category,qty,uom,price,outDate,productID"}),ini=function(){if(!o.dv){o.preIni();o.dv.find("table tbody a").live("click",function(){var a=JSON.parse(decodeURI($(this).parents("tr").attr("data")));gf.noPagination("up_member_stockTranOut",[a[0],a[4],a[8],ur.user().agentId,ur.user().id],function(){alert("\u51fa\u5e93\u6210\u529f\uff01");o.search()})})}};o.fdata=
function(a){var c=[];c.push(dom.td(a[1]));c.push(dom.td(a[2]));c.push(dom.td(a[3]));c.push(dom.td(a[4],"class=number"));c.push(dom.td("<small>"+a[5]+"</small>"));c.push(dom.td(f.date(a[7])));data=encodeURI(JSON.stringify(a));c.push(dom.td('<a href="#">\u51fa\u5e93</a>'));return dom.tr(c.join(""),'_id="'+a[0]+'" data='+data)};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("(outDate is null)");a.push(ur.user().agentId);var o=this.dv.find(".tool :text");a.push(1);a.push(o.eq(0).val());
a.push(o.eq(1).val());return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]={fun:ini,obj:o};return o}();
agent.stockIn=function(){var o=$.extend({},gobj,gpagination,{dvId:"dvStockIn",ttbl:"member.stockTranIn_v",fields:"id,orderNumber,productName,category,qty,uom,price,outDate,productID"}),ini=function(){if(!o.dv){o.preIni();o.dv.find("table tbody a").live("click",function(){var a=JSON.parse(decodeURI($(this).parents("tr").attr("data")));gf.noPagination("up_pos_stockIn",[a[0],a[4],ur.user().id],function(){alert("\u5165\u5e93\u6210\u529f\uff01");o.search()})})}},batchMoveIn=function(){};o.fdata=function(a){var c=
[];c.push(dom.td(a[1]));c.push(dom.td(a[2]));c.push(dom.td(a[3]));c.push(dom.td(a[4],"class=number"));c.push(dom.td("<small>"+a[5]+"</small>"));c.push(dom.td(f.date(a[7])));data=encodeURI(JSON.stringify(a));c.push(dom.td('<a href="#">\u5165\u5e93</a>'));return dom.tr(c.join(""),'_id="'+a[0]+'" data='+data)};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("(inDate is null)");a.push(ur.user().agentId);var o=this.dv.find(".tool :text");a.push(1);a.push(o.eq(0).val());a.push(o.eq(1).val());
return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]={fun:ini,obj:o};return o}();
agent.stock=function(){var o=$.extend({},gobj,gpagination,{fields:"ordernumber,productName,category,qty,uom,outDate,inDate"});o.fdata=function(a){var c=[];c.push(dom.td(a[0]));c.push(dom.td(a[1]));c.push(dom.td(a[2]));c.push(dom.td(a[3],"class=number"));c.push(dom.td("<small>"+a[4]+"</small>"));c.push(dom.td(f.date(a[5])));data=JSON.stringify(a);c.push(dom.td(""));return dom.tr(c.join(""),'_id="'+a[0]+'" data='+data)};return o}();
agent.stockInR=function(){var o=$.extend({},agent.stock,{dvId:"dvStockInR",ttbl:"member.stockTranIn_v2"}),ini=function(){if(!o.dv)o.preIni()};o.fdata=function(a){var c=[];c.push(dom.td(a[0]));c.push(dom.td(a[1]));c.push(dom.td(a[2]));c.push(dom.td(a[3],"class=number"));c.push(dom.td("<small>"+a[4]+"</small>"));c.push(dom.td(f.date(a[6])));data=JSON.stringify(a);c.push(dom.td(""));return dom.tr(c.join(""),'_id="'+a[0]+'" data='+data)};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("(inDate is not null)");
a.push(ur.user().agentId);var o=this.dv.find(".tool :text");a.push(1);a.push(o.eq(0).val());a.push(o.eq(1).val());return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]={fun:ini,obj:o};return o}();
agent.stockOutR=function(){var o=$.extend({},agent.stock,{dvId:"dvStockOutR",ttbl:"member.stockTranOut_v"}),ini=function(){if(!o.dv)o.preIni()};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("(outDate is not null)");a.push(ur.user().agentId);var o=this.dv.find(".tool :text");a.push(1);a.push(o.eq(0).val());a.push(o.eq(1).val());return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]={fun:ini,obj:o};return o}();
agent.categoryUpd=function(){var o=$.extend({},gobj,base.form,{dvId:"dvCategoryUpd",updProc:"up_member_updateStoreCategory",queryProc:"up_member_getStoreCategory",parent:agent.category});return o}();
agent.category=function(){var o=$.extend({},gobj,gpagination,base.query,{dvId:"dvCategory",updObj:agent.categoryUpd,ttbl:"member.storeCategory_v1",fields:"id,code,name,bname,status,[description]"}),ini=function(){if(!o.dv){o.ini();gf.noPagination("up_member_getBrandForCmb2",[1,ur.user().agentId],function(a){for(var i=0;i<a.length;i++)a[i]=[a[i][0],a[i][1]+"-"+a[i][2]];gOption.foption($(".cmbBrand"),a)})}};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("code like 'r_r%'");aF.push("name like 'r_r%'");
a[0]=ur.user().agentId;return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(dom.a(a[1],"#",'data-id="'+a[0]+'"')));c.push(dom.td(a[2]));c.push(dom.td(a[3]));c.push(dom.td(a[4]?"\u6709\u6548":"\u65e0\u6548"));c.push(dom.td(a[5]));return dom.tr(c.join(""),'data-id="'+a[0]+'"')};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.userUpd1=function(){var o=$.extend({},gobj,base.form,{dvId:"dvUserUpd",updProc:"up_user_updateStoreUser",queryProc:"up_user_getStoreUser",parent:agent.user});return o}();
base.headBodyTabForm=$.extend({},base.form,{updBodyProc:"",iniPostH:function(){var o=this;o.fields=o.dv.find(".modal-header,.modal-footer").find("[type=text],[type=number],[type=checkbox],select,textarea");o.dv.find("[name=query]").click(function(){o.queryItem(this)});if(o.iniPost)o.iniPost();o.tbl.find("tbody tr td .del").live("click",function(){o.delTr(this);$(this).parents("tr").addClass("dirty")});o.tbl.find("tbody tr td[contenteditable]").live("blur",function(){if($(this).hasClass("number"))o.changeNumber?
o.changeNumber(this):null;$(this).parents("tr").addClass("dirty")}).live("keypress",function(evt){if(evt.keyCode==13){o.pressEnter(this);return false}})},getLines:function(){},save:function(success){var a=[this.id||0,ur.user().agentId,ur.user().id],o=this;this.fields.each(function(){if($(this)[0].type=="checkbox")a.push($(this).parent().find(":checked").size());else a.push($(this).val())});var lines=this.getLines();if(lines.length===0&&!o.id&&o.otherLines===0)return;gf.getOneLine(this.updProc,a,function(a){for(var i=
0,len=lines.length,v=a[0];i<len;i++)lines[i]=[v].concat(lines[i]);o.id=a[0];if(lines.length!=0)gf.callProcBatch(o.updBodyProc,lines,function(){if(o.otherLines-lines.length==0)success?success(v):null;else o.otherLines=o.otherLines-lines.length});o.saveOtherLine?o.saveOtherLine(success):null})},delTr:function(obj){var tr=$(obj).parents("tr");if(tr.attr("data-id"))tr.hide().addClass("hide");else $(obj).parents("tr").remove()},queryItem:function(){},pressEnter:function(obj){if($(obj).hasClass("number"))o.changeNumber?
o.changeNumber(obj):null;var idx=$(obj).index();$(obj).parents("tr").next().find("td").eq(idx).focus()},queryBody:function(){var o=this;gf.noPagination(this.queryBodyProc,[o.id],function(a){var b=[],l=a.length;for(var i=0;i<l;i++)b.push(o.fdata(a[i]));o.dv.find(".modal-body table tbody:eq(0)").html(b.join(""));o.activeDv=o.dv.find(".result-header").eq(0).parent();o.searchend(l)});o.queryBodyTab?o.queryBodyTab():null},query:function(){this.queryH();this.queryBody()},clearBody:function(){this.dv.find(".modal-body table tbody").html("")},
clear:function(){this.clearH();this.clearBody()}});
agent.topUserLov=function(){var o=$.extend({},gobj,base.lov,{queryProc:"up_base_getTopUserLov",dvId:"dvTopUserLov",selectedHide:false}),state={"on":"\u542f\u7528","of":"\u5173\u95ed"};o.fdata=function(a){var tr=[];tr.push(dom.td(""));tr.push(dom.td(a[1]));tr.push(dom.td(state[a[2]]));return dom.tr(tr.join(""),"data-id="+a[0])};o.selectedItem=function(tr){tds=tr.find("td");var p={};p.id=tr.attr("data-id");p.nick=tds.eq(1).text();p.state=tds.eq(2).text();if(this.selectedHide)o.dv.modal("hide");o.callback?
o.callback(p):null};return o}();
agent.userUpd=function(){var o=$.extend({},gobj,base.headBodyTabForm,{dvId:"dvUserUpd",updProc:"up_user_updateStoreUser",updBodyProc:"up_user_updateUserRoleRel",queryProc:"up_user_getStoreUser",queryBodyProc:"up_user_getUserRoleRel",parent:agent.user}),state={"on":"\u5f00\u542f","of":"\u5173\u95ed"},selectedMenu=function(item){var a=[],ctb=' contenteditable="true"';a.push(dom.td(item.code));a.push(dom.td(item.name));a.push(dom.td(item.desc));a.push(dom.td('<i class="icon-minus del">','style="text-align: center;"'));
var l=o.dv.find(".modal-body table tbody").append(dom.tr(a.join(""),'class="dirty" data-id="'+item.id+'"')).find("tr").size();o.searchend(l)},selectedTop=function(item){var a=[];a.push(dom.td(item.nick));a.push(dom.td(item.state));a.push(dom.td('<i class="icon-minus del">','style="text-align: center;"'));var l=o.dvTop.find("table tbody").append(dom.tr(a.join(""),'class="dirty" data-id="'+item.id+'"')).find("tr").size();o.activeDv=o.dvTop;o.searchend(l)};getTopNick=function(nick,type){o.activeDv=o.dvTop;
var tr=[],tr0=o.dvTop.find('tbody tr[data-nick="'+nick+'"]'),on=dom.btn("\u5df2\u542f\u7528",'disabled class="btn"'),off=dom.btn("\u5173\u95ed",' class="btn"');if(tr0.size()>0&&type=="new"){var tds=tr0.find("td");tds.eq(1).html(on);tds.eq(2).html(off);tr0.addClass("dirty");return}if(type=="new"){tr.push(dom.td(nick));tr.push(dom.td(on));tr.push(dom.td(off));tr.push(dom.td(""))}o.dvTop.find("tbody").prepend(dom.tr(tr.join(""),'class="dirty" data-status="on" data-nick="'+nick+'"'));o.searchend(o.dvTop.find("tbody tr").size())};
o.fdata=function(b){var a=[],ctb=' contenteditable="true"';a.push(dom.td(b[1]));a.push(dom.td(b[2]));a.push(dom.td(b[3]));a.push(dom.td('<i class="icon-minus del">','style="text-align: center;"'));return dom.tr(a.join(""),'data-id="'+b[0]+'"')};o.iniPost=function(){gf.noPagination("up_user_getRoleType",[],function(a){gOption.foption(o.dv.find("#q_r_u_type"),a)});o.activeDv=o.dv.find(".tab-content .active");o.dvTop=o.dv.find("#q_m_u_top")};o.queryBodyTab=function(){gf.noPagination("up_user_getTopUser",
[o.id],function(a){var b=[],l=a.length;for(var i=0;i<l;i++){var c=[];c.push(dom.td(a[i][1]));c.push(dom.td(state[a[i][2]]));c.push(dom.td('<i class="icon-minus del">','style="text-align: center;"'));b.push(dom.tr(c.join(""),"data-id="+a[i][0]))}o.dvTop.find("table tbody").html(b.join(""));var dv=o.activeDv;o.activeDv=o.dvTop;o.searchend(l);o.activeDv=dv})};o.saveOtherLine=function(success){var a=[],b=[];o.dvTop.find("tr.dirty").each(function(){b=[];var tds=$(this).find("td"),pre="";b.push(o.id);if($(this).css("display")==
"none")pre="-";b.push(pre+$(this).attr("data-id"));a.push(b)});gf.callProcBatch("up_user_updaetUserTopNickRel",a,function(v){if(o.otherLines-a.length==0)success?success(v):null;else o.otherLines=o.otherLines-a.length})};o.getLines=function(){var a=[];o.tbl.find("tbody").eq(0).find("tr.dirty").each(function(){var b=[ur.user().id],tds=$(this).find("td"),id=$(this).attr("data-id");if($(this).css("display")=="none")id=-id;b.push(id);b.push(tds.eq(2).text());b.push(tds.eq(3).text()||0);a.push(b)});o.otherLines=
o.tbl.find("tbody tr.dirty").size();return a};o.queryItem=function(obj){if($(obj).hasClass("role"))user.roleLov.show(selectedMenu);else if($(obj).hasClass("top"))agent.topUserLov.show(selectedTop)};return o}();
agent.user=function(){var o=$.extend({},gobj,gpagination,base.query,{dvId:"dvUser",updObj:agent.userUpd,ttbl:"[user].users_v",fields:"id,memberNo,name,mobile,aname,isActive"}),ini=function(){if(!o.dv)o.ini()};o.where=function(){var a=[],aF=[];aF.push("agentId=r_r");aF.push("code like 'r_r%'");aF.push("name like 'r_r%'");a[0]=ur.user().agentId;var inputs=o.dvSp.find("input,select");a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());a.push(inputs.eq(3).val());a.push(inputs.eq(4).val());return f.getWhere_root(aF,
a)};o.fdata=function(a){var c=[];c.push(dom.td(dom.a(a[1],"#",'data-id="'+a[0]+'"')));c.push(dom.td(a[2]));c.push(dom.td(a[3]));c.push(dom.td(a[4]));c.push(dom.td(a[5]?"\u6709\u6548":"\u65e0\u6548"));return dom.tr(c.join(""),'data-id="'+a[0]+'"')};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.topUser=function(){var o=$.extend({},gobj,gpagination,{dvId:"dvTopUser",updObj:agent.userUpd,ttbl:"[user].topUser",fields:"id,nick,status"}),topOauthUrl=null,status={"of":"\u672a\u542f\u7528","on":"\u5df2\u542f\u7528"},on=dom.btn("\u5df2\u542f\u7528",'disabled class="btn"'),off=dom.btn("\u5173\u95ed",' class="btn"'),getTopNick=function(nick,type,state,id){id=id||0;gf.getOneLine("up_user_updateTopNick",[id,ur.user().agentId,nick,state],function(){o.search()})},ini=function(){if(!o.dv){o.preIni();
o.dvSp.find("[name=add]").click(function(){window.open(topOauthUrl)});o.tbl.find("tbody button").live("click",function(){var idx=$(this).parent().index();if(idx===3){var nick=$(this).parents("tr").find("td:eq(0)").text();jsonp.get(Constant.TOP_STOP_SYN_URL,{"nick":nick},function(d){if(d.ISSuccess!=1)alert(d.errorMessage);else getTopNick(nick,"old","of")})}else if(idx===2)window.open(topOauthUrl);else if(idx===4)getTopNick(nick,"old","of",-$(this).parents("tr").attr("data-id"))});jsonp.get(Constant.GET_TOP_OAUTH_URL,
"",function(data){topOauthUrl=data+"?openerFun="+ur.user().id});window.addEventListener("message",function(event){var nick=event.data["uid"+ur.user().id];if(nick)getTopNick(nick,"new","on")},false)}};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("nick like 'r_r%'");aF.push("status = 'r_r'");a[0]=ur.user().agentId;var inputs=o.dvSp.find("input,select");a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(a[1]));
c.push(dom.td(status[a[2]]));if(a[2]=="on"){c.push(dom.td(dom.btn("\u5df2\u542f\u7528",'disabled class="btn"')));c.push(dom.td(dom.btn("\u505c\u6b62",'class="btn"')));c.push(dom.td(""))}else{c.push(dom.td(dom.btn("\u542f\u7528",'class="btn"')));c.push(dom.td(dom.btn("\u5df2\u505c\u6b62",'disabled class="btn"')));c.push(dom.td(dom.btn("\u5220\u9664",'class="btn"')))}return dom.tr(c.join(""),'data-id="'+a[0]+'"')};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.topItem=function(){var o=$.extend({},gobj,gpagination,{dvId:"dvTopItem",ttbl:"dbo.topItems_v",fields:"num_iid,pp,xh,title,price,num,pic_url"}),ini=function(){if(!o.dv){o.preIni();o.setSort("pp,xh");o.dv.find("tbody a").live("click",function(){var a=[],tr=$(this).parents("tr"),tds=tr.find("td");a.push(tds.eq(2).text()||tds.eq(3).text());a.push(tds.eq(1).text());a.push(tr.attr("data-pic"));agent.topItemDetail.show(tr.attr("data-id"),a)})}};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");
aF.push("num_iid = r_r");aF.push("title like 'r_r%'");a[0]=ur.user().agentId;var inputs=o.dvSp.find("input,select");a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(a[0]));c.push(dom.td(a[1]));c.push(dom.td(a[2]));c.push(dom.td(a[3]));c.push(dom.td(f.priceLabel(a[4])));c.push(dom.td(a[5]));c.push(dom.td(dom.a("\u660e\u7ec6","#")));return dom.tr(c.join(""),'data-id="'+a[0]+'" '+'data-pic="'+a[6]+'"')};base.iniFunc[o.dvId]=
{fun:ini};return o}();
agent.topItemDetail=function(){var o={dv:null,dvId:"dvTopItemDetail"},item,importProduct=function(tr){var a=[],tds=tr.find("td");a.push(item[0]);a.push(tds.eq(1).text());a.push(tds.eq(2).text());a.push(tds.eq(0).text());a.push(o.id);a.push(tr.find("td.pid1").attr("pid"));a.push(tr.find("td.pid2").attr("pid"));a.push(tr.find("td.pid1").text());a.push(tr.find("td.pid2").text());a.push(item[1]);a.push(item[2].substr(0,item[2].lastIndexOf("/")+1));a.push(item[2].substr(item[2].lastIndexOf("/")+1));a.push(ur.user().agentId);
a.push(ur.user().id);gf.callProc_with_value("up_stock_importTopProduct",a,function(){o.show(o.id,item)})},ini=function(){if(!o.dv){o.dv=$("#"+o.dvId);o.dv.find("tbody a").live("click",function(){if($(this).hasClass("imp"))importProduct($(this).parents("tr"));else if($(this).hasClass("map"))mapProduct()})}};o.show=function(id,itm){ini();item=itm;o.id=id;gf.noPagination("up_stock_getTopItemDetail",[id],function(a){var props=a[0][3].split(";"),p={},tr=[],att1Lb="",att2Lb="";for(var i=0,b;b=props[i];i++){b=
b.split(":");if(!p[b[0]])p[b[0]]={};p[b[0]][b[1]]=b[2]+"_"+b[3]}for(var i=1,b=[];b=a[i];i++){var td=[],ps=b[3].split(";"),psd=ps[0].split(":"),pvalue="",cls="";td.push(dom.td(b[0]));td.push(dom.td(b[1]));td.push(dom.td(f.priceLabel(b[2])));pvalue=p[psd[0]][psd[1]].split("_");att1Lb=att1Lb||pvalue[0];if(att1Lb.indexOf("\u989c\u8272")>=0)cls="pid1";else cls="pid2";td.push(dom.td(pvalue[1],"class="+cls+" pid="+psd[0]));if(ps[1]){psd=ps[1].split(":");pvalue=p[psd[0]][psd[1]].split("_");att2Lb=att2Lb||
pvalue[0];if(att2Lb.indexOf("\u989c\u8272")>=0)cls="pid1";else cls="pid2";td.push(dom.td(pvalue[1],"class="+cls+" pid="+psd[0]))}else td.push(dom.td(""));td.push(dom.td(dom.a(b[4]||"\u9009\u62e9\u672c\u5730\u4ea7\u54c1","#","class=map")));td.push(dom.td(dom.a("\u5bfc\u5165\u5230\u672c\u5730","#","class=imp")));tr.push(dom.tr(td.join(""),"data-id="+b[0]))}o.dv.modal("show").find("table tbody").html(tr.join(""));o.dv.find("table thead th a").eq(3).text(att1Lb).end().eq(4).text(att2Lb)})};return o}();
base.menuLov=function(){var o=$.extend({},gobj,base.lov,{queryProc:"up_base_getMenuLov",dvId:"dvMenuLov",selectedHide:true});o.fdata=function(a){var format='<tr data-id="{0}"><td></td><td>{1}</td><td>{2}</td><td>{4}</td><td>{3}</td><td></td></tr>';return String.format.apply(null,[format].concat(a))};o.selectedItem=function(tr){tds=tr.find("td");var p={};p.id=tr.attr("data-id");p.code=tds.eq(1).text();p.name=tds.eq(2).text();p.desc=tds.eq(4).text();if(this.selectedHide)o.dv.modal("hide");o.callback?
o.callback(p):null};return o}();
agent.roleUpd=function(){var o=$.extend({},gobj,base.headBodyForm,{dvId:"dvRoleUpd",updProc:"up_user_updateStoreRole",updBodyProc:"up_user_updateRoleMenuRel",queryProc:"up_user_getStoreRole",queryBodyProc:"up_user_getRoleMenuRel",parent:agent.role}),selectedMenu=function(item){var a=[],ctb=' contenteditable="true"';a.push(dom.td(item.code));a.push(dom.td(item.name));a.push(dom.td(item.name,ctb));a.push(dom.td("",ctb));a.push(dom.td(item.desc));a.push(dom.td('<i class="icon-minus del">','style="text-align: center;"'));
var l=o.dv.find(".modal-body table tbody").append(dom.tr(a.join(""),'class="dirty" data-id="'+item.id+'"')).find("tr").size();o.searchend(l)};o.fdata=function(b){var a=[],ctb=' contenteditable="true"';a.push(dom.td(b[1]));a.push(dom.td(b[2]));a.push(dom.td(b[3],ctb));a.push(dom.td(b[4],ctb));a.push(dom.td(b[5]));a.push(dom.td('<i class="icon-minus del">','style="text-align: center;"'));return dom.tr(a.join(""),'data-id="'+b[0]+'"')};o.iniPost=function(){gf.noPagination("up_user_getRoleType",[],function(a){gOption.foption(o.dv.find("#q_r_u_type"),
a)})};o.getLines=function(){var a=[];o.tbl.find("tbody tr.dirty").each(function(){var b=[ur.user().id],tds=$(this).find("td"),id=$(this).attr("data-id");if($(this).css("display")=="none")id=-id;b.push(id);b.push(tds.eq(2).text());b.push(tds.eq(3).text()||0);a.push(b)});return a};o.queryItem=function(){var qp=base.menuLov.queryProc;base.menuLov.queryProc="up_base_getMenuLovSub";base.menuLov.selectedHide=false;base.menuLov.show(selectedMenu);base.menuLov.queryProc=qp};return o}();
agent.role=function(){var o=$.extend({},gobj,gpagination,base.query,{dvId:"dvRole",updObj:agent.roleUpd,ttbl:"[user].role_v",fields:"id,code,name,tname,status,[desc]"}),ini=function(){if(!o.dv)o.ini()};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("code like 'r_r%'");aF.push("name like 'r_r%'");a[0]=ur.user().agentId;return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(dom.a(a[1],"#",'data-id="'+a[0]+'"')));c.push(dom.td(a[2]));c.push(dom.td(a[3]));c.push(dom.td(a[4]?
"\u6709\u6548":"\u65e0\u6548"));c.push(dom.td(a[5]));return dom.tr(c.join(""),'data-id="'+a[0]+'"')};base.iniFunc[o.dvId]={fun:ini};return o}();
user.roleLov=function(){var o=$.extend({},gobj,base.lov,{queryProc:"up_user_getRoleLov",dvId:"dvRoleLov",selectedHide:true});o.fdata=function(a){var format='<tr data-id="{0}"><td></td><td>{1}</td><td>{2}</td><td>{4}</td><td>{3}</td><td></td></tr>';return String.format.apply(null,[format].concat(a))};o.selectedItem=function(tr){tds=tr.find("td");var p={};p.id=tr.attr("data-id");p.code=tds.eq(1).text();p.name=tds.eq(2).text();p.desc=tds.eq(4).text();if(this.selectedHide)o.dv.modal("hide");o.callback?
o.callback(p):null};return o}();agent.returnReasonUpd=function(){var o=$.extend({},gobj,base.form,{dvId:"dvReturnReasonUpd",updProc:"up_member_updateReturnReason",queryProc:"up_member_getReturnReason",parent:agent.returnReason});return o}();
agent.returnReason=function(){var o=$.extend({},gobj,gpagination,base.query,{dvId:"dvReturnReason",updObj:agent.returnReasonUpd,ttbl:"member.soReturnReason",fields:"id,code,name,status,[desc]"}),ini=function(){if(!o.dv)o.ini()};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("code like 'r_r%'");aF.push("name like 'r_r%'");a[0]=ur.user().agentId;return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(dom.a(a[1],"#",'data-id="'+a[0]+'"')));c.push(dom.td(a[2]));c.push(dom.td(a[3]?
"\u6709\u6548":"\u65e0\u6548"));c.push(dom.td(a[4]));return dom.tr(c.join(""),'data-id="'+a[0]+'"')};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.so=function(){var o=$.extend({},gobj,gpagination,{ttbl:"member.soHead_v2",fields:"id,orderNumber,orderDate,member,saler,amount,saleConfirmDate,aname,note,status,cname,mobile",dvId:"dvSo"}),_displayAll=false,iniRole=function(){var st=o.tbl.find("thead th").eq(3);_displayAll=false;if(ur.config().attributeDefin)for(k in ur.config().attributeDefin.role)if(ur.config().attributeDefin.role[k].id==base.STATIC.ROLE_MANAGER){_displayAll=true;break}},iniUser=function(){gf.noPagination("up_user_getStoreUserForCmb",
[ur.user().agentId],function(a){gOption.foption(o.dv.find("#q_so_user"),a,ur.user().id,["",""])})},ini=function(){if(!o.dv){o.preIni();o.dvSp.find("[name=add]").click(function(){agent.soUpd.show()});o.setSort("orderDate");gf.noPaginationSqlPara("storeID="+ur.user().agentId,"ID asc","id,code+' - '+name","member.storeCategory",function(a){gOption.foption($(".cmbCategory").eq(1),a);gOption.foption($(".cmbCategory").eq(0),a,-1,["",""])});o.tbl.find("tbody tr a").live("click",function(){agent.soUpd.show($(this).parents("tr").attr("data-id"))});
iniRole();iniUser()}},updateStatus=function(id,status){gf.callProc_with_value("up_agent_updateSoStatus",[id,status,ur.user().id],function(){o.search()})},so2po=function(id){gf.getOneLine("up_member_updateSo2Po",[id,ur.user().id,ur.user().agentId],function(a){switch(a[0]){case 1:alert("\u4ea7\u54c1\u672a\u5bf9\u5e94\u672c\u5730\u4ea7\u54c1\uff01");break;case 2:alert("\u4ea7\u54c1\u672a\u5b9a\u4e49\u4f9b\u5e94\u5546\uff01");break;case 3:alert("\u4ea7\u54c1\u7684\u91c7\u8d2d\u4ef7\u5b9a\u4e49\u5f02\u5e38\uff01");
break;default:alert("\u4ea7\u54c1\u8f6c\u6362\u6210\u529f\uff01");o.search()}})},dropdownClick=function(obj){var id=$(obj).parents("tr").attr("data-id");switch($(obj).attr("for")){case "ddprint":o.printSo(id);break;case "ddview":agent.soUpd.show(id,"view");break;case "ddedit":agent.soUpd.show(id,"edit");break;case "ddconfirm":updateStatus(id,"confirm");break;case "ddcancel":updateStatus(id,"cancel");break;case "so2po":so2po(id);break}};o.ended=function(){o.tbl.find(".dropdown-menu li:has(a)").click(function(){dropdownClick($(this))})};
o.printSo=function(id){var doc=$(frames["ptso"].document).find("div");doc.find("table:visible").remove();var tbl=doc.find("table").clone();tbl.show().appendTo(doc);var trs=tbl.find("tbody tr"),title=trs.eq(0),header=trs.eq(1),date=trs.eq(2),customer=trs.eq(3),comment=trs.eq(4),line=trs.eq(6),xj=trs.eq(7),hj=trs.eq(8),dx=trs.eq(9),a=o.data[id];title.find("td").text(ur.user().coName);date.find("td c").eq(0).text(f.date(a[2])).end().eq(1).text(a[1]);customer.find("td c").eq(0).text(a[3]).end().eq(1).text(a[7]);
comment.find("td c").text(a[8]),tqty=0,tamount=0,tdis=0;gf.noPagination("up_member_getSoLine",[id],function(a){var tds=[];for(var i=0,b=[];b=a[i];i++){if(i==0)tds=line.find("td");else{var cl=line.clone();cl.insertBefore(xj);tds=cl.find("td");tds.eq(0).text(i+1)}tds.eq(1).text(b[9]);tds.eq(2).text(b[1]);tds.eq(3).text(b[3]);tds.eq(4).text(f.price(b[2],2));tds.eq(5).text(b[4]);tqty+=b[4];tds.eq(6).text(f.price(b[2]*b[4],2));tds.eq(7).text(f.price(b[2]*b[4]*b[5]/100,2));tdis+=b[2]*b[4]*b[5]/100;tds.eq(8).text(f.price(b[2]*
b[4]*(100-b[5])/100,2));tamount+=b[2]*b[4]*(100-b[5])/100}xj.find("td").eq(1).text(tqty).end().eq(3).text(f.price(tamount,2));hj.find("td c").eq(0).text(tqty).end().eq(1).text(f.price(tamount,2)).end().eq(2).text(f.price(tdis,2));dx.find("td c").text(f.chineseNumber(tamount));frames["ptso"].print()})};o.where=function(){var a=[],aF=[];aF.push("saleID=r_r");aF.push("storeID=r_r");aF.push("orderNumber like '%r_r%'");aF.push("orderDate>= 'r_r'");aF.push("orderDate<= 'r_r'");aF.push("saleId=r_r");aF.push("status = 'r_r'");
if(!_displayAll)a.push(ur.user().id);else a.push(null);a.push(ur.user().agentId);var inputs=o.dvSp.find("input,select");a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());a.push(inputs.eq(3).val());a.push(inputs.eq(4).val());a.push(inputs.eq(5).val());return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(dom.a(a[1],"#")));c.push(dom.td(f.date(a[2])));if(a[7])c.push(dom.td(a[7]+"["+a[3]+"]"));else c.push(dom.td("\u4e2a\u4eba["+a[10]+"]"));c.push(dom.td(a[4]));c.push(dom.td(f.priceLabel(a[5])));
var stat="",stat2="",stat3="",statSo2Po="";if(a[6]&&o.param.type=="so2po")statSo2Po='<li class="" for="so2po"><a href="#"><i class="f-icon-retweet"></i>\u9500\u552e\u8f6c\u91c7\u8d2d\u5355</a></li>';if(a[9]=="cancel")stat="\u5df2\u53d6\u6d88";else{stat=a[6]&&f.date(a[6]);if(a[9]=="draft"||a[9]==""){stat="\u8349\u7a3f";stat3='  <li class="" for="ddconfirm"><a href="#"><i class="icon-ok-sign"></i>\u786e\u8ba4</a></li>'+'  <li class="" for="ddcancel"><a href="#"><i class="icon-remove-circle"></i>\u53d6\u6d88</a></li>';
stat2='  <li class="" for="ddedit"><a href="#"><i class="icon-pencil"></i>\u4fee\u6539</a></li>'}}c.push(dom.td(stat));var b=[["\u4fee\u6539","update"],["\u67e5\u770b","view"]];b=!!a[6]?b[1]:b[0];var dd='<td class="dropdown navbar">'+'<a href="#" class="dropdown-toggle" data-toggle="dropdown">\u64cd\u4f5c<b class="caret"></b></a>'+' <ul class="dropdown-menu">'+'  <li class="" for="ddview"><a href="#"><i class="icon-file"></i>\u67e5\u770b</a></li>'+stat2+'  <li for="ddprint"><a href="#"><i class="icon-print"></i>\u6253\u5370</a></li>'+
'  <li class="divider"></li> '+stat3+statSo2Po+"</ul></td>";c.push(dd);o.data[a[0]]=a;return dom.tr(c.join(""),'data-id="'+a[0]+'"')};o.updateStatus=updateStatus;base.iniFunc[o.dvId]={fun:ini,obj:o};return o}();
agent.soUpd=function(){var o=$.extend({},gobj,{dvId:"dvSoUpd",inputs:[],status:{cancel:"\u53d6\u6d88",confirm:"\u5df2\u786e\u8ba4",draft:"\u8349\u7a3f"}}),productTmpl={},productTmplList=[],productProd={},productProdList=[],iniBmap=function(){if(BMap){function G(id){return document.getElementById(id)}var ac=new BMap.Autocomplete({"input":"q_so_ud_street","location":"\u4e0a\u6d77"});ac.addEventListener("onhighlight",function(e){var str="";var _value=e.fromitem.value;var value="";if(e.fromitem.index>
-1)value=_value.province+_value.city+_value.district+_value.street+_value.business;str="FromItem<br />index = "+e.fromitem.index+"<br />value = "+value;value="";if(e.toitem.index>-1){_value=e.toitem.value;value=_value.province+_value.city+_value.district+_value.street+_value.business}str+="<br />ToItem<br />index = "+e.toitem.index+"<br />value = "+value;$(G(e.target._options.input)).attr("data-district",_value.district||_value.city)});var myValue;ac.addEventListener("onconfirm",function(e){var _value=
e.item.value;myValue=_value.province+_value.city+_value.district+_value.street+_value.business;$(G(e.target._options.input)).attr("data-district",_value.district)})}},iniHeadeD=function(){var headerDetail=o.dv.find(".dvHeaderDetail"),controller=o.dv.find(".controller").click(function(){if(ur.config().SoHeaderDetail&&ur.config().SoHeaderDetail=="show"){headerDetail.hide();controller.removeClass("f-icon-chevron-up");controller.addClass("f-icon-chevron-down");ur.config({SoHeaderDetail:"hide"})}else{headerDetail.show();
controller.removeClass("f-icon-chevron-down");controller.addClass("f-icon-chevron-up");ur.config({SoHeaderDetail:"show"})}});if(ur.config().SoHeaderDetail&&ur.config().SoHeaderDetail=="show"){headerDetail.show();controller.removeClass("f-icon-chevron-down");controller.addClass("f-icon-chevron-up");ur.config({SoHeaderDetail:"show"})}else{headerDetail.hide();controller.removeClass("f-icon-chevron-up");controller.addClass("f-icon-chevron-down");ur.config({SoHeaderDetail:"hide"})}},iniUser=function(){gf.noPagination("up_user_getStoreUserForCmb",
[ur.user().agentId],function(a){gOption.foption(o.dv.find("#q_so_u_user"),a,ur.user().id)})},iniProduct=function(){gf.noPagination("up_base_getProductTemplCode",[ur.user().agentId],function(a){for(var i=0,b=[];b=a[i];i++){productTmpl[b[1]]={id:b[0],name:b[2]};productTmplList.push({id:b[0],code:b[1],name:b[2],label:b[1]})}});gf.noPagination("up_base_getProductProdCode",[ur.user().agentId],function(a){for(var i=0,b=[];b=a[i];i++){var obj={id:b[0],code:"p"+b[1],name:b[3],label:b[2],price:b[6],uom:b[7]};
if(productProd["p"+b[1]])productProd["p"+b[1]].push(obj);else productProd["p"+b[1]]=[obj]}})},iniAttrDefin=function(){if(ur.config().attributeDefin)for(k in ur.config().attributeDefin.product){var t=o.tbl.find("thead ."+k).show(),pa=ur.config().attributeDefin.product[k];if(pa.isUn){t.show();t.find("a").text(pa.label)}else t.hide()}},sugSelectProd=function(pp,item){var tr=pp.parents("tr").attr("data-prod-id",item.id),tds=tr.find("td");tds.eq(1).text(item.name);tds.eq(2).text(1);tds.eq(3).text(item.price);
tds.eq(4).text(item.uom);tds.eq(5).text(0);tds.eq(6).text(item.price)},suggestProd=function(){o.tbl.find("tbody tr").each(function(){var pt=$(this).find("td:eq(0)");pt.autocomplete({minLength:0,source:productTmplList,focus:function(event,ui){pt.text(ui.item.code)},select:function(event,ui){pt.text(ui.item.code);return false}}).data("autocomplete")._renderItem=function(ul,item){return $("<li>").data("item.autocomplete",item).append("<a>"+item.code+"<small>"+item.name+"</small></a>").appendTo(ul)};
var pp=$(this).find("td:eq(1)");pp.autocomplete({minLength:0,autoFocus:true,source:function(req,rep){rep(productProd[pp.parents("tr").attr("data-tmpl-id")])},focus:function(event,ui){pp.text(ui.item.name);sugSelectProd(pp,ui.item);return false},select:function(event,ui){pp.text(ui.item.name);sugSelectProd(pp,ui.item);return false}}).data("autocomplete")._renderItem=function(ul,item){return $("<li>").data("item.autocomplete",item).append("<a><small>"+item.name+"</small></a>").appendTo(ul)}})},checkProduct=
function(pobj){if($(pobj).index()==0){var pt=productTmpl[$(pobj).text().toUpperCase()];if(pt){$(pobj).data({"tmpl-id":pt.id,"tmpl-code":$(pobj).text().toUpperCase(),"tmpl-name":pt.name});$(pobj).text($(pobj).text().toUpperCase()+" "+pt.name);$(pobj).parents("tr").attr("data-tmpl-id","p"+pt.id);if(productProd["p"+pt.id].length===1)sugSelectProd($(pobj),productProd["p"+pt.id][0])}else $(pobj).focus()}},ini=function(){if(!o.dv){o.preIni();o.dv.find("button[name=query]").click(function(){agent.productLovMutil.show(selectedProduct,
"ag");o.dv.modal("hide")});o.dv.find("button[name=clear]").click(function(){clear()});o.partner=o.dv.find("#q_so_u_partner").next().click(function(){agent.partnerLov.show(fillPartner,o.partner.val(),"customer")}).end().blur(function(){$(this).val($(this).attr("data-code")||""+" "+($(this).attr("data-name")||""))}).focus(function(){$(this).val($(this).attr("data-code")||"")});o.dv.find("#q_so_u_user").keydown(function(evt){if(evt.keyCode===9&&(ur.config().SoHeaderDetail&&ur.config().SoHeaderDetail==
"hide"||!ur.config().SoHeaderDetail)){o.tbl.find("tbody tr:eq(0) td:eq(0)").focus();return false}});o.dv.find("#q_so_ud_date").keydown(function(evt){if(evt.keyCode===9||evt.keyCode===13){o.tbl.find("tbody tr:eq(0) td:eq(0)").focus();return false}});var userMobile=o.dv.find("#q_so_ud_tel");userMobile.blur(function(){if($(this).val().length!=11)$(this).focus()});try{suggest.mobile(userMobile,function(item,obj){o.inputs.eq(9).val(item.tips).attr("data-district",item.districtCode)})}catch(e){}o.tbl.find("tbody tr td[contenteditable]").live("blur",
function(){if($(this).hasClass("number"))changeNumber(this);$(this).parents("tr").addClass("dirty");checkProduct(this)}).live("keypress",function(evt){if(evt.keyCode==13){pressEnter(this);return false}}).live("focus",function(){if($(this).index()==0)$(this).text($(this).data("tmpl-code"))});o.tbl.find("tbody tr td .del").live("click",function(){delTr(this)});o.dv.find(".result-header button[name=clear]").click(function(){clear()});o.dv.find(".result-header .dropdown-menu li:has(a)").click(function(){clickDropMenu($(this))});
o.inputs=o.dvSp.find("input,select");o.total=o.dv.find("#q_so_u_total");iniHeadeD();iniBmap();iniProduct();iniAttrDefin();iniUser()}},selectedProduct=function(a){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb="";delbtn=""}for(var i=0,b=[];b=a[i];i++){var td=[];if(o.tbl.find("tbody tr[data-prod-id="+b[0]+"]").size()>0)continue;td.push(dom.td(b[1]));if(o.tbl.find("thead th:eq(1)").css("display")!=
"none")td.push(dom.td(b[7]||""));else td.push(dom.td("","display:none"));td.push(dom.td("1",'class="number" '+ctb));td.push(dom.td(b[2],'class="number" '+ctb));td.push(dom.td("<small>"+b[3]+"</small>"));td.push(dom.td(o.discount||b[5]||"0",ctb+' class="number"'));td.push(dom.td(b[2]*(100-(o.discount||0))/100,'class="number"'));td.push(dom.td("",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));var attr='data-prod-id="'+b[0]+'"';if(b[7])attr+=' data-id="'+b[7]+'"';tr.push(dom.tr(td.join(""),
attr))}o.tbl.find("tbody").prepend(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,"yyyy-MM-dd HH:mm:ss"));total()},confirmOrder=function(){o.inputs.eq(4).attr("data-value","confirm");submit(function(id){agent.so.updateStatus(id,"confirm");o.show(id)})},cancelOrder=function(){o.inputs.eq(4).attr("data-value","cancel");submit()},clickDropMenu=function(obj){if(obj.hasClass("confirm"))confirmOrder();else if(obj.hasClass("cancel"))cancelOrder();
else if(obj.hasClass("clear"))clear()},pressEnter=function(obj){if($(obj).hasClass("number"))changeNumber(obj);var idx=$(obj).index();$(obj).parents("tr").next().find("td").eq(idx).focus()},changeNumber=function(obj){var tds=$(obj).parents("tr").find("td"),price=tds.eq(3).text(),num=tds.eq(2).text()||0;tds.eq(6).text(parseFloat(price)*parseInt(num)*(100-parseInt(tds.eq(5).text()||0))/100);total()},total=function(){var t=0;o.tbl.find("tbody tr:not(.hide)").each(function(){t+=parseFloat($(this).find("td:eq(7)").text()||
0)});o.total.val(f.price(t,2))},fillPartner=function(p){o.partner.val(p.code+" "+p.name).attr({"data-id":p.id,"data-code":p.code,"data-name":p.name});o.discount=p.discount},delTr=function(obj){var tr=$(obj).parents("tr");if(tr.attr("data-id"))tr.hide().addClass("hide");else $(obj).parents("tr").remove();total()},fillProduct=function(a){fdataLine(a);total()},addSo=function(head,lines,success){gf.callProc_with_value("up_member_createSoHead1",head,function(v){for(var i=0,len=lines.length;i<len;i++)lines[i]=
[v].concat(lines[i]);if(lines.length>0)gf.callProcBatch("up_member_createSoLine",lines,function(){success(v)})})},displayBtn=function(){o.dv.find(".btn:not(.lov .btn)").hide();o.dv.find("input,textarea,.lov .btn").disable()},showBtn=function(){o.dv.find(".btn").show();o.dv.find("input:not(#q_so_u_total,#q_so_u_status),textarea,.lov .btn").enable()},fdataHead=function(a){o.inputs.eq(0).val(a[0]);o.inputs.eq(1).val(a[9]+" "+a[10]).attr({"data-code":a[9],"data-name":a[10],"data-id":a[5]});o.inputs.eq(2).val(a[2]);
o.inputs.eq(4).val(a[4]);o.inputs.eq(5).val(o.status[a[11]]||o.status["draft"]).attr("data-value",a[11]||"draft");o.inputs.eq(6).val(a[3]);if(a[11]=="cancel"||a[11]=="confirm")displayBtn();else showBtn();o.dv.find(".modal-footer textarea").text(a[8]);o.inputs.eq(7).val(a[12]);o.inputs.eq(8).val(a[13]);o.inputs.eq(9).attr("data-district",a[14]).val(a[15]);o.inputs.eq(10).val(a[16])},fdataLine=function(a){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';
if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb="";delbtn=""}for(var i=0,b=[];b=a[i];i++){var td=[];if(o.tbl.find("tbody tr[data-prod-id="+b[0]+"]").size()>0)continue;td.push(dom.td(b[1]));if(o.tbl.find("thead th:eq(1)").css("display")!="none")td.push(dom.td(b[10]||""));else td.push(dom.td("","display:none"));if(o.tbl.find("thead th:eq(2)").css("display")!="none")td.push(dom.td(b[11]||""));else td.push(dom.td("","display:none"));td.push(dom.td(b[4]||
"1",'class="number" '+ctb));td.push(dom.td(b[2],'class="number" '+ctb));td.push(dom.td("<small>"+b[3]+"</small>"));td.push(dom.td(f.price(b[5],2)||"0",ctb+' class="number"'));td.push(dom.td(f.price(b[2]*b[4]*(100-parseFloat(b[5]))/100,2),'class="number"'));td.push(dom.td(b[6]||"",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));var attr='data-prod-id="'+b[0]+'"';if(b[7])attr+=' data-id="'+b[7]+'"';tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,
"yyyy-MM-dd HH:mm:ss"))},getHead=function(id,type){gf.getOneLine("up_member_getSoHead2",[id],function(a){fdataHead(a);getLine(id);o.dv.find(".modal-header h3").find("c").text(type=="view"?"\u67e5\u770b":"\u4fee\u6539").end().find("small").text("["+a[17]+"]")})},getLine=function(id){gf.noPagination("up_member_getSoLine2",[id],function(a){o.tbl.find("tbody").html("");fillProduct(a)})},submit=function(success){var head=[],line=[],lines=[],om=this,uid=ur.user().id;head.push(o.inputs.eq(0).val()||0);head.push(o.inputs.eq(6).val());
if(!o.inputs.eq(1).val()&&!o.inputs.eq(7).val()){o.inputs.eq(1).addClass("error");return}else o.inputs.eq(1).removeClass("error");head.push(o.inputs.eq(1).attr("data-id")||0);head.push(o.inputs.eq(2).val());head.push(o.inputs.eq(4).val());head.push(o.dv.find(".modal-footer textarea").text()||"");head.push(o.inputs.eq(5).attr("data-value")||"draft");head.push(o.inputs.eq(7).val());head.push(o.inputs.eq(8).val());head.push(o.inputs.eq(9).attr("data-district"));head.push(o.inputs.eq(9).val());head.push(o.inputs.eq(10).val());
head.push(uid);head.push(ur.user().agentId);o.tbl.find("tbody tr").each(function(){var obj=$(this),tds=obj.find("td");line=[];if(obj.hasClass("dirty")||!obj.attr("data-id")||obj.css("display")=="none"){var id=parseInt(obj.attr("data-id")||0);if(obj.css("display")=="none")id=-id;line.push(id);line.push(obj.attr("data-prod-id"));line.push(tds.eq(2).text());line.push(tds.eq(3).text());line.push(tds.eq(5).text());line.push(tds.eq(7).text());line.push(uid);if(line[2])lines.push(line)}});if(lines.length||
head[0]>0)addSo(head,lines,success)},close=function(){o.dv.modal("hide")},defaultLine=function(){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';for(var i=0;i<5;i++){var td=[];td.push(dom.td("",ctb));if(o.tbl.find("thead th:eq(1)").css("display")!="none")td.push(dom.td("",ctb));else td.push(dom.td("","display:none"));td.push(dom.td("",'class="number" '+ctb));td.push(dom.td("",'class="number" '+ctb));td.push(dom.td("<small></small>"));td.push(dom.td("",
ctb+' class="number"'));td.push(dom.td("",'class="number"'));td.push(dom.td("",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));tr.push(dom.tr(td.join("")))}o.tbl.find("tbody").append(tr.join(""));suggestProd()},clear=function(){o.tbl.find("tbody").html("");o.inputs.val("").eq(2).val(gf.dateFormat(new Date,"yyyy-MM-dd"));o.inputs.eq(10).val(gf.dateFormat(gf.addDay(new Date,1),"yyyy-MM-dd"));o.inputs.eq(5).val(o.status["draft"]).attr("data-value","draft");showBtn();o.dv.find(".modal-header h3").find("c").text("\u65b0\u589e").end().find("small").text("");
defaultLine()};o.show=function(id,type){ini();o.dv.modal({backdrop:"static"});if(id)getHead(id,type);else clear()};o.saveClose=function(){submit(function(){close();agent.so.search()})};o.saveAdd=function(){submit(clear)};return o}();
agent.soReturn=function(){var o=$.extend({},gobj,gpagination,{ttbl:"member.soReturnHead_v",fields:"id,orderNumber,orderDate,member,saler,amount,saleConfirmDate,aname,note,status,rname",dvId:"dvSoReturn"}),ini=function(){if(!o.dv){o.preIni();o.dvSp.find("[name=add]").click(function(){agent.soReturnUpd.show()});gf.noPagination("up_member_getReturnReasonForCmb",[ur.user().agentId],function(a){var b=[];for(var i=0,c=[];c=a[i];i++)if(c[3])b.push(c);gOption.foption($(".cmbReturnReason").eq(1),b);gOption.foption($(".cmbReturnReason").eq(0),
a,-1,["",""])});o.tbl.find("tbody tr a").live("click",function(){agent.soReturnUpd.show($(this).parents("tr").attr("data-id"))})}},updateStatus=function(id,status){gf.callProc_with_value("up_agent_updateSoStatus",[id,status,ur.user().id],function(){o.search()})},dropdownClick=function(obj){var id=$(obj).parents("tr").attr("data-id");switch($(obj).attr("for")){case "ddprint":o.printSo(id);break;case "ddview":agent.soReturnUpd.show(id,"view");break;case "ddedit":agent.soReturnUpd.show(id,"edit");break;
case "ddconfirm":updateStatus(id,"confirm");break;case "ddcancel":updateStatus(id,"cancel");break}};o.ended=function(){o.tbl.find(".dropdown-menu li:has(a)").click(function(){dropdownClick($(this))})};o.printSo=function(id){var doc=$(frames["ptso"].document).find("div");doc.find("table:visible").remove();var tbl=doc.find("table").clone();tbl.show().appendTo(doc);var trs=tbl.find("tbody tr"),title=trs.eq(0),header=trs.eq(1),date=trs.eq(2),customer=trs.eq(3),comment=trs.eq(4),line=trs.eq(6),xj=trs.eq(7),
hj=trs.eq(8),dx=trs.eq(9),a=o.data[id];title.find("td").text(ur.user().coName);header.find("td").text("\u9000\u8d27\u5355");date.find("td c").eq(0).text(f.date(a[2])).end().eq(1).text(a[1]);customer.find("td c").eq(0).text(a[3]).end().eq(1).text(a[7]);comment.find("td c").text(a[8]),tqty=0,tamount=0,tdis=0;gf.noPagination("up_member_getSoLine",[id],function(a){var tds=[];for(var i=0,b=[];b=a[i];i++){if(i==0)tds=line.find("td");else{var cl=line.clone();cl.insertBefore(xj);tds=cl.find("td");tds.eq(0).text(i+
1)}b[4]=b[4]*-1;tds.eq(1).text(b[9]);tds.eq(2).text(b[1]);tds.eq(3).text(b[3]);tds.eq(4).text(f.price(b[2],2));tds.eq(5).text(b[4]);tqty+=b[4];tds.eq(6).text(f.price(b[2]*b[4],2));tdis+=b[2]*b[4]*b[5]/100;tds.eq(8).text(f.price(b[2]*b[4]*(100-b[5])/100,2));tamount+=b[2]*b[4]*(100-b[5])/100}xj.find("td").eq(1).text(tqty).end().eq(3).text(f.price(tamount,2));hj.find("td c").eq(0).text(tqty).end().eq(1).text(f.price(tamount,2)).end().eq(2).text(f.price(tdis,2));dx.find("td c").text(f.chineseNumber(tamount));
frames["ptso"].print()})};o.where=function(){var a=[],aF=[];aF.push("storeID=r_r");aF.push("orderNumber like '%r_r%'");aF.push("orderDate>= 'r_r'");aF.push("orderDate<= 'r_r'");aF.push("status = 'r_r'");a.push(ur.user().agentId);var inputs=o.dvSp.find("input,select");a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());a.push(inputs.eq(3).val());a.push(inputs.eq(4).val());return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(dom.a(a[1],"#")));c.push(dom.td(f.date(a[2])));c.push(dom.td(a[7]+
"["+a[3]+"]"));c.push(dom.td(a[4]));c.push(dom.td('<label class=number style="width:50%">'+f.price(a[5],2)+"</label>"));c.push(dom.td(a[10]));var stat="",stat2="",stat3="";if(a[9]=="cancel")stat="\u5df2\u53d6\u6d88";else{stat=a[6]&&f.date(a[6]);if(a[9]=="draft"||a[9]==""){stat="\u8349\u7a3f";stat3='  <li class="" for="ddconfirm"><a href="#"><i class="icon-ok-sign"></i>\u786e\u8ba4</a></li>'+'  <li class="" for="ddcancel"><a href="#"><i class="icon-remove-circle"></i>\u53d6\u6d88</a></li>';stat2='  <li class="" for="ddedit"><a href="#"><i class="icon-pencil"></i>\u4fee\u6539</a></li>'}}c.push(dom.td(stat));
var b=[["\u4fee\u6539","update"],["\u67e5\u770b","view"]];b=!!a[6]?b[1]:b[0];var dd='<td class="dropdown navbar">'+'<a href="#" class="dropdown-toggle" data-toggle="dropdown">\u64cd\u4f5c<b class="caret"></b></a>'+' <ul class="dropdown-menu">'+'  <li class="" for="ddview"><a href="#"><i class="icon-file"></i>\u67e5\u770b</a></li>'+stat2+'  <li for="ddprint"><a href="#"><i class="icon-print"></i>\u6253\u5370</a></li>'+'  <li class="divider"></li> '+stat3+"</ul></td>";c.push(dd);o.data[a[0]]=a;return dom.tr(c.join(""),
'data-id="'+a[0]+'"')};o.updateStatus=updateStatus;base.iniFunc[o.dvId]={fun:ini};return o}();
agent.soReturnUpd=function(){var o=$.extend({},gobj,{dvId:"dvSoReturnUpd",inputs:[],status:{cancel:"\u53d6\u6d88",confirm:"\u5df2\u786e\u8ba4",draft:"\u8349\u7a3f"}}),ini=function(){if(!o.dv){o.preIni();o.dv.find("button[name=query]").click(function(){agent.soProductQuery.show(selectedProduct,o.partner.attr("data-id"),ur.user().id)});o.dv.find("button[name=clear]").click(function(){clear()});o.partner=o.dv.find("#q_so_ru_partner").next().click(function(){agent.partnerMemberLov.show(fillPartner,o.partner.val(),
ur.user().id,"customer")}).end().blur(function(){$(this).val($(this).attr("data-code")||""+" "+($(this).attr("data-name")||""))}).focus(function(){$(this).val($(this).attr("data-code")||"")});o.tbl.find("tbody tr td[contenteditable]").live("blur",function(){$(this).parents("tr").addClass("dirty");pressEnter(this)}).live("keypress",function(evt){if(evt.keyCode==13){pressEnter(this);return false}});o.tbl.find("tbody tr td .del").live("click",function(){delTr(this)});o.dv.find(".result-header button[name=clear]").click(function(){clear()});
o.dv.find(".result-header .dropdown-menu li:has(a)").click(function(){clickDropMenu($(this))});o.inputs=o.dvSp.find("input,select");o.total=o.dv.find("#q_so_ru_total")}},selectedProduct=function(a){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb="";delbtn=""}for(var i=0,b=null;b=a[i];i++){var td=[];td.push(dom.td(b.productName));td.push(dom.td(b.maxQty,
'class="number" '+ctb));td.push(dom.td(b.maxPrice,'class="number" '+ctb));td.push(dom.td("/"+b.uom));td.push(dom.td(b.maxQty*b.maxPrice));td.push(dom.td(b.orderNum));td.push(dom.td("",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));attr='data-maxQty="'+b.maxQty+'" data-maxPrice="'+b.maxPrice+'" data-fromId="'+b.lineId+'" data-prod-id="'+b.productId+'"';tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,
"yyyy-MM-dd HH:mm:ss"));total()},confirmOrder=function(){o.inputs.eq(4).attr("data-value","confirm");submit(function(id){agent.so.updateStatus(id,"confirm");o.show(id)})},cancelOrder=function(){o.inputs.eq(4).attr("data-value","cancel");submit()},clickDropMenu=function(obj){if(obj.hasClass("confirm"))confirmOrder();else if(obj.hasClass("cancel"))cancelOrder();else if(obj.hasClass("clear"))clear()},pressEnter=function(obj){if($(obj).hasClass("number")){var tr=$(obj).parents("tr");if($(obj).index()==
1){if(parseFloat($(obj).text())>parseFloat(tr.attr("data-maxqty"))){$(obj).text(tr.attr("data-maxqty")).focus();gtips.showNotice("\u4e0d\u80fd\u5927\u4e8e\u8ba2\u5355\u7684\u6570\u91cf");return}}else if($(obj).index()==2)if(parseFloat($(obj).text())>parseFloat(tr.attr("data-maxprice"))){$(obj).text(tr.attr("data-maxprice")).focus();gtips.showNotice("\u4e0d\u80fd\u5927\u4e8e\u8ba2\u5355\u4e0a\u9762\u7684\u5355\u4ef7");return}changeNumber(obj)}var idx=$(obj).index();$(obj).parents("tr").next().find("td").eq(idx).focus()},
changeNumber=function(obj){var tds=$(obj).parents("tr").find("td"),price=tds.eq(2).text(),num=tds.eq(1).text()||0;tds.eq(4).text(parseFloat(price)*parseInt(num));total()},total=function(){var t=0;o.tbl.find("tbody tr:not(.hide)").each(function(){t+=parseFloat($(this).find("td:eq(4)").text()||0)});o.total.val(f.price(t,2))},fillPartner=function(p){o.partner.val(p.code+" "+p.name).attr({"data-id":p.id,"data-code":p.code,"data-name":p.name});o.discount=p.discount},delTr=function(obj){var tr=$(obj).parents("tr");
if(tr.attr("data-id"))tr.hide().addClass("hide");else $(obj).parents("tr").remove();total()},fillProduct=function(a){fdataLine(a);total()},addSo=function(head,lines,success){gf.callProc_with_value("up_member_createSoReturnHead",head,function(v){for(var i=0,len=lines.length;i<len;i++)lines[i]=[v].concat(lines[i]);if(lines.length>0)gf.callProcBatch("up_member_createSoReturnLine",lines,function(){success(v)})})},displayBtn=function(){o.dv.find(".btn:not(.lov .btn)").hide();o.dv.find("input,textarea,.lov .btn").disable()},
showBtn=function(){o.dv.find(".btn").show();o.dv.find("input:not(#q_so_ru_total,#q_so_ru_status),textarea,.lov .btn").enable()},fdataHead=function(a){o.inputs.eq(0).val(a[0]);o.inputs.eq(1).val(a[9]+" "+a[10]).attr({"data-code":a[9],"data-name":a[10],"data-id":a[5]});o.inputs.eq(2).val(a[2]);o.inputs.eq(3).val(a[4]);o.inputs.eq(4).val(o.status[a[11]]||o.status["draft"]).attr("data-value",a[11]||"draft");if(a[11]=="cancel"||a[11]=="confirm")displayBtn();else showBtn();o.dv.find(".modal-footer textarea").text(a[8])},
fdataLine=function(a){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb="";delbtn=""}for(var i=0,b=[];b=a[i];i++){var td=[];if(o.tbl.find("tbody tr[data-prod-id="+b[0]+"]").size()>0)continue;td.push(dom.td(b[1]));td.push(dom.td(b[4]*-1||"1",'class="number" '+ctb));td.push(dom.td(b[2],'class="number" '+ctb));td.push(dom.td("<small>"+b[3]+"</small>"));td.push(dom.td(b[2]*
b[4]*parseFloat(b[5]||0-100)/100,'class="number"'));td.push(dom.td(b[10]||""));td.push(dom.td(b[6]||"",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));var attr='data-prod-id="'+b[0]+'"';if(b[7])attr+=' data-id="'+b[7]+'"';tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,"yyyy-MM-dd HH:mm:ss"))},getHead=function(id,type){gf.getOneLine("up_member_getSoReturnHead",
[id],function(a){fdataHead(a);getLine(id);o.dv.find(".modal-header h3").find("c").text(type=="view"?"\u67e5\u770b":"\u4fee\u6539").end().find("small").text("[MRT"+a[0]+"]")})},getLine=function(id){gf.noPagination("up_member_getSoLine",[id],function(a){o.tbl.find("tbody").html("");fillProduct(a)})},submit=function(success){var head=[],line=[],lines=[],om=this,uid=ur.user().id;head.push(o.inputs.eq(0).val()||0);head.push(uid);if(!o.inputs.eq(1).val()){o.inputs.eq(1).addClass("error");return}else o.inputs.eq(1).removeClass("error");
head.push(o.inputs.eq(1).attr("data-id"));head.push(o.inputs.eq(2).val());head.push(o.inputs.eq(4).val());head.push(o.inputs.eq(3).val());head.push(o.dv.find(".modal-footer textarea").text()||"");head.push(o.inputs.eq(5).attr("data-value")||"draft");head.push(uid);o.tbl.find("tbody tr").each(function(){var obj=$(this),tds=obj.find("td");line=[];if(obj.hasClass("dirty")||!obj.attr("data-id")||obj.css("display")=="none"){var id=parseInt(obj.attr("data-id")||0);if(obj.css("display")=="none")id=-id;line.push(id);
line.push(obj.attr("data-prod-id"));line.push("-"+tds.eq(1).text());line.push(tds.eq(2).text());line.push(obj.attr("data-fromId"));line.push(tds.eq(6).text());line.push(uid);lines.push(line)}});if(lines.length||head[0]>0)addSo(head,lines,success)},close=function(){o.dv.modal("hide")},clear=function(){o.tbl.find("tbody").html("");o.inputs.val("").eq(2).val(gf.dateFormat(new Date,"yyyy-MM-dd"));o.inputs.eq(5).val(o.status["draft"]).attr("data-value","draft");showBtn();o.dv.find(".modal-header h3").find("c").text("\u65b0\u589e").end().find("small").text("")};
o.show=function(id,type){ini();o.dv.modal({backdrop:"static"});if(id)getHead(id,type);else clear()};o.saveClose=function(){submit(function(){close();agent.soReturn.search()})};o.saveAdd=function(){submit(clear)};return o}();
agent.soExchange=function(){var o=$.extend({},gobj,gpagination,{ttbl:"member.soExchangeHead_v",fields:"id,orderNumber,orderDate,member,saler,amount,saleConfirmDate,aname,note,status,rname",dvId:"dvSoExchange"}),ini=function(){if(!o.dv){o.preIni();o.dvSp.find("[name=add]").click(function(){agent.soExchangeUpd.show()});gf.noPagination("up_member_getReturnReasonForCmb",[ur.user().agentId],function(a){var b=[];for(var i=0,c=[];c=a[i];i++)if(c[3])b.push(c);gOption.foption($(".cmbReturnReason").eq(3),b);
gOption.foption($(".cmbReturnReason").eq(2),a,-1,["",""])});o.tbl.find("tbody tr a").live("click",function(){agent.soExchangeUpd.show($(this).parents("tr").attr("data-id"))})}},updateStatus=function(id,status){gf.callProc_with_value("up_agent_updateSoStatus",[id,status,ur.user().id],function(){o.search()})},dropdownClick=function(obj){var id=$(obj).parents("tr").attr("data-id");switch($(obj).attr("for")){case "ddprint":o.printSo(id);break;case "ddview":agent.soExchangeUpd.show(id,"view");break;case "ddedit":agent.soExchangeUpd.show(id,
"edit");break;case "ddconfirm":updateStatus(id,"confirm");break;case "ddcancel":updateStatus(id,"cancel");break}};o.ended=function(){o.tbl.find(".dropdown-menu li:has(a)").click(function(){dropdownClick($(this))})};o.printSo=function(id){var doc=$(frames["ptsoExchange"].document).find("div");doc.find("table:visible").remove();var tbl=doc.find("table").clone();tbl.show().appendTo(doc);var trs=tbl.find("tbody tr"),title=trs.eq(0),header=trs.eq(1),date=trs.eq(2),customer=trs.eq(3),comment=trs.eq(4),
linein=trs.eq(7),lineout=trs.eq(10),xjin=trs.eq(8),xjout=trs.eq(11),hj=trs.eq(12),dx=trs.eq(13),a=o.data[id];title.find("td").text(ur.user().coName);date.find("td c").eq(1).text(f.date(a[2])).end().eq(0).text(a[1]);customer.find("td c").eq(0).text(a[3]).end().eq(1).text(a[7]);comment.find("td c").text(a[8]),tqty=0,tqtyin=0,tqtyout=0,tamount=0,tamountin=0,tamountout=0,tdis=0;gf.noPagination("up_member_getSoLine",[id],function(a){var tds=[],ain=[],aout=[];for(var i=0,b=[];b=a[i];i++)if(b[4]<0)ain.push(b);
else aout.push(b);for(var i=0,b=[];b=ain[i];i++){if(i==0)tds=linein.find("td");else{var cl=linein.clone();cl.insertBefore(xj);tds=cl.find("td");tds.eq(0).text(i+1)}tds.eq(1).text(b[9]);tds.eq(2).text(b[1]);tds.eq(3).text(b[3]);tds.eq(4).text(f.price(b[2],2));tds.eq(5).text(b[4]*-1);tqtyin+=b[4]*-1;tds.eq(6).text(f.price(b[2]*b[4]*-1,2));tds.eq(7).text(f.price(b[2]*b[4]*b[5]/100,2));tdis+=b[2]*b[4]*b[5]/100;tds.eq(8).text(f.price(b[2]*b[4]*(b[5]-100)/100,2));tamountin+=b[2]*b[4]*(b[5]-100)/100}for(var i=
0,b=[];b=aout[i];i++){if(i==0)tds=lineout.find("td");else{var cl=lineout.clone();cl.insertBefore(xj);tds=cl.find("td");tds.eq(0).text(i+1)}tds.eq(1).text(b[9]);tds.eq(2).text(b[1]);tds.eq(3).text(b[3]);tds.eq(4).text(f.price(b[2],2));tds.eq(5).text(b[4]);tqtyout+=b[4];tds.eq(6).text(f.price(b[2]*b[4],2));tds.eq(7).text(f.price(b[2]*b[4]*b[5]/100,2));tdis+=b[2]*b[4]*b[5]/100;tds.eq(8).text(f.price(b[2]*b[4]*(100-b[5])/100,2));tamountout+=b[2]*b[4]*(100-b[5])/100}tamount=tamountout-tamountin;xjin.find("td").eq(1).text(tqtyin).end().eq(3).text(f.price(tamountin,
2));xjout.find("td").eq(1).text(tqtyout).end().eq(3).text(f.price(tamountout,2));hj.find("td c").eq(0).text(tqtyin+tqtyout).end().eq(1).text(f.price(tamount,2)).end().eq(2).text(f.price(tdis,2));dx.find("td c").text(f.chineseNumber(tamount));frames["ptsoExchange"].print()})};o.where=function(){var a=[],aF=[];aF.push("storeID=r_r");aF.push("orderNumber like '%r_r%'");aF.push("orderDate>= 'r_r'");aF.push("orderDate<= 'r_r'");aF.push("status = 'r_r'");a.push(ur.user().agentId);var inputs=o.dvSp.find("input,select");
a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());a.push(inputs.eq(3).val());a.push(inputs.eq(4).val());return f.getWhere_root(aF,a)};o.fdata=function(a){var c=[];c.push(dom.td(dom.a(a[1],"#")));c.push(dom.td(f.date(a[2])));c.push(dom.td(a[7]+"["+a[3]+"]"));c.push(dom.td(a[4]));c.push(dom.td('<label class=number style="width:50%">'+f.price(a[5],2)+"</label>"));c.push(dom.td(a[10]));var stat="",stat2="",stat3="";if(a[9]=="cancel")stat="\u5df2\u53d6\u6d88";else{stat=a[6]&&f.date(a[6]);if(a[9]==
"draft"||a[9]==""){stat="\u8349\u7a3f";stat3='  <li class="" for="ddconfirm"><a href="#"><i class="icon-ok-sign"></i>\u786e\u8ba4</a></li>'+'  <li class="" for="ddcancel"><a href="#"><i class="icon-remove-circle"></i>\u53d6\u6d88</a></li>';stat2='  <li class="" for="ddedit"><a href="#"><i class="icon-pencil"></i>\u4fee\u6539</a></li>'}}c.push(dom.td(stat));var b=[["\u4fee\u6539","update"],["\u67e5\u770b","view"]];b=!!a[6]?b[1]:b[0];var dd='<td class="dropdown navbar">'+'<a href="#" class="dropdown-toggle" data-toggle="dropdown">\u64cd\u4f5c<b class="caret"></b></a>'+
' <ul class="dropdown-menu">'+'  <li class="" for="ddview"><a href="#"><i class="icon-file"></i>\u67e5\u770b</a></li>'+stat2+'  <li for="ddprint"><a href="#"><i class="icon-print"></i>\u6253\u5370</a></li>'+'  <li class="divider"></li> '+stat3+"</ul></td>";c.push(dd);o.data[a[0]]=a;return dom.tr(c.join(""),'data-id="'+a[0]+'"')};o.updateStatus=updateStatus;base.iniFunc[o.dvId]={fun:ini};return o}();
agent.soExchangeUpd=function(){var o=$.extend({},gobj,{dvId:"dvSoExchangeUpd",inputs:[],status:{cancel:"\u53d6\u6d88",confirm:"\u5df2\u786e\u8ba4",draft:"\u8349\u7a3f"}}),ini=function(){if(!o.dv){o.preIni();o.dv.find("button[name=query]").eq(1).click(function(){agent.productLovMutil.show(selectedProduct,"ag");o.dv.modal("hide")}).end().eq(0).click(function(){agent.soProductQuery.show(selectedProductR,o.partner.attr("data-id"),ur.user().id)});o.dv.find("button[name=clear]").click(function(){clear()});
o.partner=o.dv.find("#q_so_ec_partner").next().click(function(){agent.partnerMemberLov.show(fillPartner,o.partner.val(),"customer")}).end().blur(function(){$(this).val($(this).attr("data-code")||""+" "+($(this).attr("data-name")||""))}).focus(function(){$(this).val($(this).attr("data-code")||"")});o.tbl.find("tbody tr td[contenteditable]").live("blur",function(){$(this).parents("tr").addClass("dirty");pressEnter(this)}).live("keypress",function(evt){if(evt.keyCode==13){pressEnter(this);return false}});
o.tbl.find("tbody tr td .del").live("click",function(){delTr(this)});o.dv.find(".result-header button[name=clear]").click(function(){clear()});o.dv.find(".result-header .dropdown-menu li:has(a)").click(function(){clickDropMenu($(this))});o.inputs=o.dvSp.find("input,select");o.total=o.dv.find("#q_so_ec_total")}},selectedProductR=function(a){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';if(o.inputs.eq(5).attr("data-value")=="cancel"||o.inputs.eq(5).attr("data-value")==
"confirm"){ctb="";delbtn=""}for(var i=0,b=null;b=a[i];i++){var td=[];td.push(dom.td(b.productName));td.push(dom.td(b.maxQty,'class="number" '+ctb));td.push(dom.td(b.maxPrice,'class="number" '+ctb));td.push(dom.td("/"+b.uom));td.push(dom.td(b.maxQty*b.maxPrice));td.push(dom.td(b.orderNum));td.push(dom.td("",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));attr='data-maxQty="'+b.maxQty+'" data-maxPrice="'+b.maxPrice+'" data-fromId="'+b.lineId+'" data-prod-id="'+b.productId+'" data-pre="-1"';
tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").eq(0).append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,"yyyy-MM-dd HH:mm:ss"));total()},selectedProduct=function(a){var tr=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb="";delbtn=""}for(var i=0,b=[];b=a[i];i++){var td=
[];if(o.tbl.find("tbody:eq(1) tr[data-prod-id="+b[0]+"]").size()>0)continue;td.push(dom.td(b[1]));td.push(dom.td("1",'class="number" '+ctb));td.push(dom.td(b[2],'class="number" '+ctb));td.push(dom.td("<small>/"+b[3]+"</small>"));td.push(dom.td(o.discount||b[5]||"0",ctb+' class="number"'));td.push(dom.td(b[2]*(100-(o.discount||0))/100,'class="number"'));td.push(dom.td(b[6]||"",ctb));td.push(dom.td(delbtn,'style="text-align: center;"'));var attr='data-prod-id="'+b[0]+'"  data-pre="1"';if(b[7])attr+=
' data-id="'+b[7]+'"';tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").eq(1).append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,"yyyy-MM-dd HH:mm:ss"));total()},confirmOrder=function(){o.inputs.eq(5).attr("data-value","confirm");submit(function(id){agent.so.updateStatus(id,"confirm");o.show(id)})},cancelOrder=function(){o.inputs.eq(5).attr("data-value","cancel");submit()},clickDropMenu=function(obj){if(obj.hasClass("confirm"))confirmOrder();
else if(obj.hasClass("cancel"))cancelOrder();else if(obj.hasClass("clear"))clear()},pressEnter=function(obj){if($(obj).hasClass("number")){var tr=$(obj).parents("tr");if(tr.attr("data-pre")<0)if($(obj).index()==1){if(parseFloat($(obj).text())>parseFloat(tr.attr("data-maxqty"))){$(obj).text(tr.attr("data-maxqty")).focus();gtips.showNotice("\u4e0d\u80fd\u5927\u4e8e\u8ba2\u5355\u7684\u6570\u91cf");return}}else if($(obj).index()==2)if(parseFloat($(obj).text())>parseFloat(tr.attr("data-maxprice"))){$(obj).text(tr.attr("data-maxprice")).focus();
gtips.showNotice("\u4e0d\u80fd\u5927\u4e8e\u8ba2\u5355\u4e0a\u9762\u7684\u5355\u4ef7");return}changeNumber(obj)}var idx=$(obj).index();$(obj).parents("tr").next().find("td").eq(idx).focus()},changeNumber=function(obj){var tr=$(obj).parents("tr"),tds=tr.find("td"),price=tds.eq(2).text(),num=tds.eq(1).text()||0;if(tr.attr("data-pre")<0)tds.eq(4).text(parseFloat(price)*parseInt(num));else tds.eq(5).text(parseFloat(price)*parseInt(num)*(100-parseInt(tds.eq(4).text()||0))/100);total()},totalSub=function(){var t=
0;o.tbl.each(function(){t=0;$(this).find("tbody tr:not(.hide)").each(function(){if($(this).attr("data-pre")>0)t+=parseFloat($(this).find("td:eq(5)").text()||0);else t+=parseFloat($(this).find("td:eq(4)").text()||0)});$(this).prev().find("div").eq(1).text(f.price(t,2))})},total=function(){var t=0;o.tbl.find("tbody tr:not(.hide)").each(function(){if($(this).attr("data-pre")>0)t+=parseFloat($(this).find("td:eq(5)").text()||0)*$(this).attr("data-pre");else t+=parseFloat($(this).find("td:eq(4)").text()||
0)*$(this).attr("data-pre")});o.total.val(f.price(t,2));totalSub()},fillPartner=function(p){o.partner.val(p.code+" "+p.name).attr({"data-id":p.id,"data-code":p.code,"data-name":p.name});o.discount=p.discount},delTr=function(obj){var tr=$(obj).parents("tr");if(tr.attr("data-id"))tr.hide().addClass("hide");else $(obj).parents("tr").remove();total()},fillProduct=function(a){fdataLine(a);total()},addSo=function(head,lines,success){gf.callProc_with_value("up_member_createSoExchangeHead",head,function(v){for(var i=
0,len=lines.length;i<len;i++)lines[i]=[v].concat(lines[i]);if(lines.length>0)gf.callProcBatch("up_member_createSoExchangeLine",lines,function(){success(v)})})},displayBtn=function(){o.dv.find(".btn:not(.lov .btn)").hide();o.dv.find("input,textarea,.lov .btn").disable()},showBtn=function(){o.dv.find(".btn").show();o.dv.find("input:not(#q_so_ec_total,#q_so_ec_status),textarea,.lov .btn").enable()},fdataHead=function(a){o.inputs.eq(0).val(a[0]);o.inputs.eq(1).val(a[9]+" "+a[10]).attr({"data-code":a[9],
"data-name":a[10],"data-id":a[5]});o.inputs.eq(2).val(a[2]);o.inputs.eq(3).val(a[4]);o.inputs.eq(4).val(o.status[a[11]]||o.status["draft"]).attr("data-value",a[11]||"draft");if(a[11]=="cancel"||a[11]=="confirm")displayBtn();else showBtn();o.dv.find(".modal-footer textarea").text(a[8])},fdataLine=function(a){var tr1=[],tr2=[];o.dv.modal("show");var ctb=' contenteditable="true"',delbtn='<i class="icon-minus del">';if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb=
"";delbtn=""}for(var i=0,b=[];b=a[i];i++){var td=[];if(o.tbl.find("tbody tr[data-prod-id="+b[0]+"]").size()>0)continue;td.push(dom.td(b[1]));var pre=1;if(b[4]<0)pre=-1;td.push(dom.td(b[4]*pre||"1",'class="number" '+ctb));td.push(dom.td(b[2],'class="number" '+ctb));td.push(dom.td("<small>/"+b[3]+"</small>"));if(pre>0)td.push(dom.td(b[5]||"0",ctb+' class="number"'));td.push(dom.td(b[2]*b[4]*pre*(100-parseFloat(b[5]))/100,'class="number"'));if(pre<0)td.push(dom.td(b[10]));td.push(dom.td(b[6]||"",ctb));
td.push(dom.td(delbtn,'style="text-align: center;"'));var attr='data-prod-id="'+b[0]+'"';if(b[7])attr+=' data-id="'+b[7]+'"';if(pre<0){attr+=' data-pre="-1"';tr1.push(dom.tr(td.join(""),attr))}else{attr+=' data-pre="1"';tr2.push(dom.tr(td.join(""),attr))}}o.tbl.find("tbody").eq(0).append(tr1.join("")).end().eq(1).append(tr2.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,"yyyy-MM-dd HH:mm:ss"))},getHead=function(id,type){gf.getOneLine("up_member_getSoExchangeHead",
[id],function(a){fdataHead(a);getLine(id);o.dv.find(".modal-header h3").find("c").text(type=="view"?"\u67e5\u770b":"\u4fee\u6539").end().find("small").text("[MEC"+a[0]+"]")})},getLine=function(id){gf.noPagination("up_member_getSoLine",[id],function(a){o.tbl.find("tbody").html("");fillProduct(a)})},submit=function(success){var head=[],line=[],lines=[],om=this,uid=ur.user().id;head.push(o.inputs.eq(0).val()||0);head.push(uid);if(!o.inputs.eq(1).val()){o.inputs.eq(1).addClass("error");return}else o.inputs.eq(1).removeClass("error");
head.push(o.inputs.eq(1).attr("data-id"));head.push(o.inputs.eq(2).val());head.push(o.inputs.eq(4).val());head.push(o.inputs.eq(3).val());head.push(o.dv.find(".modal-footer textarea").text()||"");head.push(o.inputs.eq(5).attr("data-value")||"draft");head.push(uid);o.tbl.find("tbody tr").each(function(){var obj=$(this),tds=obj.find("td");line=[];if(obj.hasClass("dirty")||!obj.attr("data-id")||obj.css("display")=="none"){var id=parseInt(obj.attr("data-id")||0),pre=obj.attr("data-pre");if(obj.css("display")==
"none")id=-id;line.push(id);line.push(obj.attr("data-prod-id"));line.push(tds.eq(1).text()*pre);line.push(tds.eq(2).text());if(pre<0)line.push(0);else line.push(tds.eq(4).text()||0);line.push(obj.attr("data-fromId")||"null");line.push(tds.eq(6).text());line.push(uid);lines.push(line)}});if(lines.length||head[0]>0)addSo(head,lines,success)},close=function(){o.dv.modal("hide")},clear=function(){o.tbl.find("tbody").html("");o.inputs.val("").eq(2).val(gf.dateFormat(new Date,"yyyy-MM-dd"));o.inputs.eq(5).val(o.status["draft"]).attr("data-value",
"draft");showBtn();o.dv.find(".modal-header h3").find("c").text("\u65b0\u589e").end().find("small").text("")};o.show=function(id,type){ini();o.dv.modal({backdrop:"static"});if(id)getHead(id,type);else clear()};o.saveClose=function(){submit(function(){close();agent.soExchange.search()})};o.saveAdd=function(){submit(clear)};return o}();
agent.soProductQuery=function(){var o=$.extend({},gobj,{dvId:"dvSoProductQuery",inputs:[]}),callback=null,ini=function(){if(!o.dv)o.preIni()},where=function(){return"1=1"},search=function(){gf.query("agent.base.soProductQuery",[o.memberId,o.saleId,where()],function(a){var c=[],d=[];for(var i=0,b=[];b=a[i];i++){c=[];c.push(dom.td('<input type="checkbox" />'));c.push(dom.td(b[0]));c.push(dom.td(f.date(b[5])));c.push(dom.td(b[2]));c.push(dom.td(b[3]));c.push(dom.td(b[8]+"/"+"<small>"+b[10]+"</small>"));
c.push(dom.td(b[4]));d.push(dom.tr(c.join(""),'data-productId="'+b[7]+'" data-lineId="'+b[6]+'" data-price="'+b[8]+'" data-uomId="'+b[9]+'" data-uom="'+b[10]+'"'))}o.dv.find("tbody").html(d.join(""))})};o.saveClose=function(){var a=[];o.dv.find("tbody tr:has(:checked)").each(function(){var p={},tr=$(this),tds=tr.find("td");p.productId=tr.attr("data-productId");p.lineId=tr.attr("data-lineId");p.maxQty=tds.eq(4).text();p.maxPrice=tr.attr("data-price");p.uom=tr.attr("data-uom");p.uomId=tr.attr("data-uomId");
p.orderNum=tds.eq(1).text();p.productName=tds.eq(3).text();a.push(p)});if(callback){callback(a);o.dv.modal("hide")}};o.show=function(callbk,memberId,saleId){ini();if(!memberId||!saleId)gtips.showNotice("\u8bf7\u5148\u9009\u62e9\u4e1a\u52a1\u4f19\u4f34\uff01");o.memberId=memberId||0;o.saleId=saleId;callback=callbk;search();o.dv.modal({backdrop:false})};return o}();
agent.giftdelSta=function(){var o=$.extend({},_cmbAddress,gobj,gpagination,{id:"",agentId:"",fields:"ID,userName,gender,IdCardNo,mobile,address,GiftName,CREATION_DATE,Donation,memberNo,aname",ttbl:"member.giftDelivery_v4",fileNamePrefix:"memberlist",toexcel_fields:"ID,memberNo,name,companyName,address,mobile,IdCardNo,memberDate,gender",dvUpdate:null,dvId:"dvGiftDelSta"}),ini=function(){if(!o.dv){var om=o;o.preIni();o.dvUpdate=$("#dvUpdateMember");o.cmbAddress=o.dvUpdate.find(".address select");o.dvUpdate.find(".icon_close").click(function(){om.dvUpdate.fadeOut()});
o.oTbl=o.dv.find("table");o.dvUpdate.find(".btnSave").click(function(){var a=[];a.push(ur.user().id);a.push(om.id);a.push(om.parentId);a.push(om.cmbAddress.eq(2).val());var btn=$(this).val("\u6b63\u5728\u6dfb\u52a0");om.dvUpdate.find(".content table td :text").each(function(){a.push($(this).val())});gf.callProc("",a,function(){gtips.showNotice("\u6dfb\u52a0\u5b8c\u6bd5!");btn.val("\u786e\u5b9a\u4fdd\u5b58");om.dvUpdate.fadeOut()})})}},show=function(obj,parentName,parentId,id){this.iniAddr();var o=
this.dvUpdate.find("table td");o.eq(0).text(parentName);gf.show(obj,this.dvUpdate,{x:"center",y:"center"});this.id="";this.parentId=parentId;if(id)this.id=id};o.fdata=function(a){var c=[];c.push(dom.td(a[1]));c.push(dom.td(a[3].substr(0,a[3].length-4)+"****"));c.push(dom.td(a[4]));c.push(dom.td(a[5]));c.push(dom.td(a[6]));c.push(dom.td(f.date(a[7])));c.push(dom.td(a[10]));return dom.tr(c.join(""),'_id="'+a[0]+'"')};o.where=function(){var a=[],aF=[];aF.push("agentId!=r_r");aF.push("code like 'r_r%'");
aF.push("name like 'r_r%'");aF.push("IdCardNo like 'r_r%'");aF.push("mobile like 'r_r%'");aF.push("marketingId = r_r");a.push("372");a.push(ur.user().code);this.dv.find(".well").find(":text,select").each(function(){a.push($(this).val())});return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]={fun:ini}}();
agent.brand=function(){var o=$.extend({},gobj,gpagination,{dvId:"dvBrand",ttbl:"stock.brand_v",fields:"id,code,name,status,[desc]"}),ini=function(){if(!o.dv){o.preIni();o.dvSp.find("[name=add]").click(function(){agent.brandUpd.show()});o.tbl.find("tbody a").live("click",function(){agent.brandUpd.show($(this).attr("data-id"))})}};o.where=function(){var a=[],aF=[];aF.push("storeId=r_r");aF.push("code like 'r_r%'");aF.push("name like 'r_r%'");a[0]=ur.user().agentId;return f.getWhere_root(aF,a)};o.fdata=
function(a){var c=[];c.push(dom.td(dom.a(a[1],"#",'data-id="'+a[0]+'"')));c.push(dom.td(a[2]));c.push(dom.td(a[3]?"\u6709\u6548":"\u65e0\u6548"));c.push(dom.td(a[4]));return dom.tr(c.join(""),'data-id="'+a[0]+'"')};base.iniFunc[o.dvId]={fun:ini};return o}();
agent.brandUpd=function(){var o=$.extend({},gobj,base.form,{dvId:"dvBrandUpd",updProc:"up_stock_updateBrand",queryProc:"up_member_getBrand1",parent:agent.brand});o.queryH=function(){var o=this;gf.getOneLine(this.queryProc,[o.id,ur.user().agentId],function(a){o.fields.each(function(i){if($(this)[0].type=="checkbox"){if(a[i]>0)$(this).attr("checked","checked")}else $(this).val(a[i])})})};selectedItem=function(item){o.partner.val(item.code+" "+item.name).attr("data-id",item.id)};o.iniPost=function(){o.partner=
o.dv.find(".btnVendor").click(function(){agent.partnerLov.show(selectedItem,$(this).prev().val(),"vendor")}).prev()};return o}();
agent.purchasOrder=function(){var o=$.extend({},gobj,gpagination,{ttbl:"member.poHead_v",fields:"id,orderNumber,orderDate,member,saler,amount,saleConfirmDate,aname,note,status,acode,per",dvId:"dvPurchasOrder"}),ini=function(){if(!o.dv){o.preIni();o.oTbl=o.dv.find(".report-results>table");o.dv.find(".vehicle_search button[name=query]").click(function(){o.search()});o.dv.find(".vehicle_search button[name=add]").click(function(){agent.purchasOrderUpd.show("","create")});o.oTbl.find("tbody tr a").live("click",
function(){agent.purchasOrderUpd.show($(this).parents("tr").attr("data-id"))})}};o.fdata=function(a){var c=[],cd="";c.push(dom.td('<a href="#">'+a[1]+"</a>"));c.push(dom.td(f.date(a[2])));c.push(dom.td('<label class=number style="width:50%">'+f.price(a[5],2)+"</label>"));c.push(dom.td(a[7]+"["+a[4]+"]"));if(a[9]=="cancel")cd="\u5df2\u53d6\u6d88";else cd=a[6]?f.date(a[6]):"\u8349\u7a3f";c.push(dom.td(cd));c.push(dom.td('<div class="progress progress-striped active"><div class="bar" style="width: '+
(parseFloat(a[11])*100||0)+'%"></div></div>'));c.push(dom.td(""));return dom.tr(c.join(""),'data-id="'+a[0]+'"')};o.where=function(){var a=[],aF=[];aF.push("storeID=r_r");aF.push("orderNumber like '%r_r%'");aF.push("orderDate>= 'r_r'");aF.push("orderDate<= 'r_r'");aF.push("status = 'r_r'");a.push(ur.user().agentId);var inputs=o.dvSp.find("input,select");a.push(inputs.eq(1).val());a.push(inputs.eq(2).val());a.push(inputs.eq(3).val());a.push(inputs.eq(4).val());return f.getWhere_root(aF,a)};base.iniFunc[o.dvId]=
{fun:ini};return o}();
base.poUpd={partner:null,getReason:function(agentId){var o=this;if(!o.dv.find(".cmbReturnReason"))return;gf.noPagination("up_member_getReturnReasonForCmb",[agentId],function(a){var b=[];for(var i=0,c=[];c=a[i];i++)if(c[3])b.push(c);gOption.foption(o.dv.find(".cmbReturnReason"),b)})},getVendor:function(){var o=this;gf.getOneLine("up_pos_getDefaultVendor",[ur.user().agentId],function(a){o.partner.val(a[1]+" "+a[2]).attr({"data-id":a[0],"data-code":a[1],"data-name":a[2],"data-aid":a[3]});o.getReason(a[0])})}};
agent.purchasOrderUpd=function(){var o=$.extend({},gobj,base.poUpd,{dvId:"dvPoUpd",inputs:[],status:{cancel:"\u53d6\u6d88",confirm:"\u5df2\u786e\u8ba4",draft:"\u8349\u7a3f"}}),ini=function(){if(!o.dv){o.preIni();o.dv.find("button[name=query]").click(function(){agent.productLovMutil.show(selectedProduct,"ag",o.partner.attr("data-aid"));o.dv.modal("hide")});o.dv.find("button[name=clear]").click(function(){clear()});o.partner=o.dv.find("#q_po_vendor").next().click(function(){agent.partnerLov.show(fillPartner,
"customer")}).end().blur(function(){$(this).val($(this).attr("data-code")||""+" "+($(this).attr("data-name")||""))}).focus(function(){$(this).val($(this).attr("data-code")||"")});o.tbl.find("tbody tr td[contenteditable]").live("blur",function(){if($(this).hasClass("number"))changeNumber(this);$(this).parents("tr").addClass("dirty")}).live("keypress",function(evt){if(evt.keyCode==13){pressEnter(this);return false}});o.tbl.find("tbody tr td .del").live("click",function(){delTr(this)});o.dv.find(".result-header button[name=clear]").click(function(){clear()});
o.dv.find(".result-header .dropdown-menu li:has(a)").click(function(){clickDropMenu($(this))});o.inputs=o.dvSp.find("input");o.total=o.dv.find("#q_po_total");o.getVendor()}},selectedProduct=function(a){var tr=[];o.dv.modal("show");var ctb1=' contenteditable="true"',delbtn='<i class="icon-minus del">';ctb="";if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb="";delbtn=""}for(var i=0,b=[];b=a[i];i++){var td=[];if(o.tbl.find("tbody tr[data-prod-id="+b[0]+
"]").size()>0)continue;td.push(dom.td(b[1]));td.push(dom.td("1",'class="number" '+ctb1));td.push(dom.td(b[2],'class="number" '+ctb));td.push(dom.td("<small>"+b[3]+"</small>"));td.push(dom.td(b[5]||"0",ctb+' class="number"'));td.push(dom.td(b[2],'class="number"'));td.push(dom.td(b[6]||"",ctb1));td.push(dom.td(delbtn,'style="text-align: center;"'));var attr='data-prod-id="'+b[0]+'"';if(b[7])attr+=' data-id="'+b[7]+'"';tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,
"yyyy-MM-dd HH:mm:ss"));total()},confirmOrder=function(){o.inputs.eq(4).attr("data-value","confirm");submit()},cancelOrder=function(){o.inputs.eq(4).attr("data-value","cancel");submit()},clickDropMenu=function(obj){if(obj.hasClass("confirm"))confirmOrder();else if(obj.hasClass("cancel"))cancelOrder()},pressEnter=function(obj){if($(obj).hasClass("number"))changeNumber(obj);var idx=$(obj).index();$(obj).parents("tr").next().find("td").eq(idx).focus()},changeNumber=function(obj){var tds=$(obj).parents("tr").find("td"),
price=tds.eq(2).text(),num=tds.eq(1).text()||0;tds.eq(5).text(parseFloat(price)*parseInt(num)*(100-parseInt(tds.eq(4).text()||0))/100);total()},total=function(){var t=0;o.tbl.find("tbody tr:not(.hide)").each(function(){t+=parseFloat($(this).find("td:eq(5)").text()||0)});o.total.val(t)},fillPartner=function(p){o.partner.val(p.code+" "+p.name).attr({"data-id":p.id,"data-code":p.code,"data-name":p.name})},delTr=function(obj){var tr=$(obj).parents("tr");if(tr.attr("data-id"))tr.hide().addClass("hide");
else $(obj).parents("tr").remove();total()},fillProduct=function(a){fdataLine(a);total()},addSo=function(head,lines,success){gf.callProc_with_value("up_member_createSoHead",head,function(v){for(var i=0,len=lines.length;i<len;i++)lines[i]=[v].concat(lines[i]);if(lines.length>0)gf.callProcBatch("up_member_createSoLine",lines,function(){success()})})},displayBtn=function(){o.dv.find(".btn:not(.lov .btn)").hide();o.dv.find("input,textarea,.lov .btn").disable()},showBtn=function(){o.dv.find(".btn").show();
o.dv.find("input:not(#q_po_total,#q_po_status),textarea,.lov .btn").enable()},fdataHead=function(a){o.inputs.eq(0).val(a[0]);o.inputs.eq(1).val(a[9]+" "+a[10]).attr({"data-code":a[9],"data-name":a[10],"data-id":a[5]});o.inputs.eq(2).val(a[2]);o.inputs.eq(3).val(a[4]);o.inputs.eq(4).val(o.status[a[11]]||o.status["draft"]).attr("data-value",a[11]||"draft");if(a[11]=="cancel"||a[11]=="confirm")displayBtn();else showBtn();o.dv.find(".modal-footer textarea").text(a[8])},fdataLine=function(a){var tr=[];
o.dv.modal("show");var ctb1=' contenteditable="true"',delbtn='<i class="icon-minus del">';var ctb="";if(o.inputs.eq(4).attr("data-value")=="cancel"||o.inputs.eq(4).attr("data-value")=="confirm"){ctb1="";delbtn=""}for(var i=0,b=[];b=a[i];i++){var td=[];if(o.tbl.find("tbody tr[data-prod-id="+b[0]+"]").size()>0)continue;td.push(dom.td(b[1]));td.push(dom.td(b[4]||"1",'class="number" '+ctb1));td.push(dom.td(b[2],'class="number" '+ctb));td.push(dom.td("<small>"+b[3]+"</small>"));td.push(dom.td(b[5]||"0",
ctb+' class="number"'));td.push(dom.td(b[2],'class="number"'));td.push(dom.td(b[6]||"",ctb1));td.push(dom.td(delbtn,'style="text-align: center;"'));var attr='data-prod-id="'+b[0]+'"';if(b[7])attr+=' data-id="'+b[7]+'"';tr.push(dom.tr(td.join(""),attr))}o.tbl.find("tbody").append(tr.join(""));o.dv.find(".result-header").find("c").text(o.tbl.find("tbody tr").size()).end().find("d").text(gf.dateFormat(new Date,"yyyy-MM-dd HH:mm:ss"))},getHead=function(id){gf.getOneLine("up_member_getPoHead",[id],function(a){fdataHead(a);
getLine(id);o.dv.find(".modal-header h3").find("c").text("\u4fee\u6539").end().find("small").text("[MSO"+a[0]+"]")})},getLine=function(id){gf.noPagination("up_member_getPoLine",[id],function(a){o.tbl.find("tbody").html("");fillProduct(a)})},submit=function(success){var head=[],line=[],lines=[],om=this,uid=ur.user().id;head.push(o.inputs.eq(0).val()||0);if(!o.inputs.eq(1).val()){o.inputs.eq(1).addClass("error");return}else o.inputs.eq(1).removeClass("error");head.push(o.inputs.eq(1).attr("data-id"));
head.push(uid);head.push(o.inputs.eq(2).val());head.push(o.inputs.eq(3).val());head.push(o.dv.find(".modal-footer textarea").text()||"");head.push(o.inputs.eq(4).attr("data-value")||"draft");head.push(uid);o.tbl.find("tbody tr").each(function(){var obj=$(this),tds=obj.find("td");line=[];if(obj.hasClass("dirty")||!obj.attr("data-id")||obj.css("display")=="none"){var id=parseInt(obj.attr("data-id")||0);if(obj.css("display")=="none")id=-id;line.push(id);line.push(obj.attr("data-prod-id"));line.push(tds.eq(1).text());
line.push(tds.eq(2).text());line.push(tds.eq(4).text());line.push(tds.eq(6).text());line.push(uid);lines.push(line)}});if(lines.length||head[0]>0)addSo(head,lines,success)},close=function(){o.dv.modal("hide")},clear=function(){o.tbl.find("tbody").html("");o.inputs.eq(3).val("").end().eq(2).val(gf.dateFormat(new Date,"yyyy-MM-dd"));o.inputs.eq(4).val(o.status["draft"]).attr("data-value","draft");showBtn();o.dv.find(".modal-header h3").find("c").text("\u65b0\u589e").end().find("small").text("")};o.show=
function(id){ini();o.dv.modal({backdrop:"static"});if(id)getHead(id);else clear()};o.saveClose=function(){submit(function(){close();agent.po.search()})};o.saveAdd=function(){submit(clear)};return o}();
